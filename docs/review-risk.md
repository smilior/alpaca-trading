# RISK レビュー v3: リスク管理観点からの深掘り改善提案

> 「最悪のシナリオは？」 -- v2で多層防御の骨格は整った。v3では防御の盲点と動的リスク管理を追求する。

## エグゼクティブサマリー

v2レビューで提案したスリッページバッファ30%、回路ブレーカー閾値調整（Level 1: 4%, Level 2: 7%）、多層ストップロス構造、VIX連動ポジション制限、相関リスク管理はいずれもstrategy.mdとsystem-design.mdに反映された。多層防御の骨格としては十分な水準に達している。

しかし、v2では「何をすべきか」を示したに留まり、「どう実装するか」「パラメータの根拠は何か」「動的にどう適応するか」の3点が未解決のまま残っている。v3では以下の8つの論点について、v2の「その先」を定量的に掘り下げる。特に、(1) ギャップリスクの確率分布モデル、(2) 動的相関管理、(3) ストレステストの具体的シナリオ再現は、ペーパートレーディング開始前に設計を完了すべき優先課題である。

---

## v2からの残課題と新規論点

### 1. ギャップリスクの確率分布モデル -- ヒストリカルデータからの推定

#### 現状の問題

v2でスリッページバッファ30%（SLIPPAGE_FACTOR = 1.3）をポジションサイズ計算に織り込んだ。しかし、この「30%」の根拠が不明確なままだ。実際のギャップダウン分布はファットテールであり、30%が適切なのか、過大なのか、過小なのか、ヒストリカルデータなしには判断できない。

さらに深刻なのは、ギャップの大きさが一様ではないことだ。決算発表後のギャップ、マクロイベント（FOMC、CPI）後のギャップ、地政学イベント後のギャップは、それぞれ異なる分布特性を持つ。一律30%のバッファでは、あるイベントでは過剰に保守的で資本効率を殺し、別のイベントでは過少で防御が破れる。

#### 最悪のシナリオ

スリッページバッファ30%を信頼して設計したが、実際の決算発表後ギャップダウンの95パーセンタイルが-8%（ATR x 4.0相当）であり、ATR x 2.0のストップロスに30%バッファを加えても実損失がバッファを大幅に超過する。5ポジション中2つが同日決算で被弾し、1日で総資金の6-8%を喪失。回路ブレーカーLevel 2（7%）が発動するが、損失は既に確定済み。「バッファがあるから大丈夫」という偽の安心感が、リスクの過小見積もりを招く。

#### 改善提案

1. **Phase 0のバックテストデータを活用したギャップ分布の推定**: 過去2年分4,000件の決算データ（strategy.md Phase 0で収集予定）から、以下を算出する。

```
分析対象:
  - 決算発表後の翌営業日始値 vs 前日終値のギャップ幅（全4,000件）
  - 上記のうちネガティブギャップ（下方向）のサブセット
  - LLMポジティブ判定 + 初日-2%以上下落のサブセット

算出指標:
  - ギャップ幅の中央値、平均、標準偏差
  - 90パーセンタイル、95パーセンタイル、99パーセンタイル
  - ギャップ幅の分布フィッティング（正規分布、t分布、一般化パレート分布）
  - ATR対比のギャップ倍率（ギャップ幅 / ATR(14)）の分布
```

2. **イベント種別ごとのスリッページ係数テーブル**: 一律30%ではなく、イベント種別に応じた係数を設定する。

```
| イベント種別          | 推定スリッページ係数 | 根拠                          |
|-----------------------|----------------------|-------------------------------|
| 決算発表（通常）      | 1.5-2.0              | 95%ileのギャップ/ATR比から算出 |
| 決算発表（サプライズ）| 2.0-3.0              | EPS miss + ガイダンス引下げ    |
| FOMC/CPI              | 1.2-1.5              | マクロイベントは分散が小さい   |
| 地政学イベント        | 3.0-5.0              | テールイベント、制御不能       |
| 通常日（決算なし）    | 1.1-1.2              | 平時のスプレッド拡大程度       |
```

3. **ポジション保有中銘柄の決算日チェックの自動化**: v2で「決算発表2営業日前にポジション縮小」ルールを提案したが、これをシステムに組み込む具体的な設計が必要。

```python
# modules/risk_manager.py に追加
def check_earnings_proximity(positions: list, earnings_calendar: dict) -> list:
    """保有ポジションの決算接近をチェック"""
    warnings = []
    for pos in positions:
        earnings_date = earnings_calendar.get(pos.symbol)
        if earnings_date and (earnings_date - today).days <= 2:
            warnings.append({
                "symbol": pos.symbol,
                "earnings_date": earnings_date,
                "action": "reduce_50pct",  # ポジション50%縮小
                "reason": "earnings_proximity"
            })
    return warnings
```

---

### 2. 相関リスクの動的管理 -- DCC-GARCHモデルの導入検討

#### 現状の問題

v2でセクター間相関マトリクスの月次更新と実効分散度の計算を提案し、strategy.mdのセクション6に反映された。しかし、月次更新の静的相関では「危機の瞬間に相関が1.0に収束する」というv2で自ら指摘した問題に対処できない。

静的相関の根本的限界は、危機が起きてから1ヶ月後に「あ、相関が高まっていた」と認識する点だ。リスク管理には「今この瞬間の相関」が必要であり、事後的な月次更新では遅すぎる。

#### 最悪のシナリオ

月次更新の相関マトリクスでは、先月までXLK-XLF間相関が0.3だったため、テクノロジー2銘柄+金融2銘柄のポジションを「十分に分散」と判断。しかし、FRBのサプライズ利上げ発表で金利感応度が共通リスクファクターとなり、当日の実効相関が0.85に急騰。4ポジション全てが-3%以上。実効分散度は4 x (1 - 0.85) = 0.6まで崩壊。月次相関マトリクスが示す「分散されている」は完全な幻想だった。

#### 改善提案

1. **DCC-GARCH（Dynamic Conditional Correlation GARCH）の段階的導入**: 完全なDCC-GARCHの実装はPhase 0-1では過剰だが、簡易版として「ローリング相関の高速更新」を提案する。

```python
# 簡易版: 20日ローリング相関（月次ではなく日次更新）
import numpy as np

def calculate_rolling_correlation(returns_matrix: np.ndarray, window: int = 20) -> np.ndarray:
    """日次更新のローリング相関マトリクス"""
    n_assets = returns_matrix.shape[1]
    corr_matrix = np.corrcoef(returns_matrix[-window:].T)
    return corr_matrix

def calculate_ewma_correlation(returns_matrix: np.ndarray, lambda_: float = 0.94) -> np.ndarray:
    """EWMA（指数加重移動平均）相関 -- 直近のデータに重みを置く"""
    # RiskMetrics方式: 危機時の相関変化を素早く捕捉
    n = returns_matrix.shape[0]
    weights = np.array([(1 - lambda_) * lambda_**i for i in range(n-1, -1, -1)])
    weights /= weights.sum()
    weighted_returns = returns_matrix * weights[:, np.newaxis]
    return np.corrcoef(weighted_returns.T)
```

2. **相関ブレイクアウト警告**: 日次相関がローリング相関の+2σを超えた場合にアラートを発動。

```
相関ブレイクアウト条件:
  - 20日ローリング相関の平均 + 2 x 標準偏差を超えた場合
  - 対応: 該当ペアの合計エクスポージャーを50%に制限
  - VIX > 25かつ相関ブレイクアウト: 全ポジション数を3以下に強制縮小
```

3. **相関レジーム分類**: 低相関期（平常時）と高相関期（危機時）を二値で分類し、レジームごとにポジション上限を切り替える。

```
| 相関レジーム       | 判定条件                              | 最大ポジション | 実効分散度要件 |
|--------------------|---------------------------------------|----------------|----------------|
| 低相関（平常）     | 平均ペア相関 < 0.5 かつ VIX < 25      | 5              | >= 2.0         |
| 高相関（警戒）     | 平均ペア相関 >= 0.5 または VIX 25-30   | 3              | >= 1.5         |
| 超高相関（危機）   | 平均ペア相関 >= 0.7 または VIX > 30    | 1-2            | 制限なし       |
```

4. **将来的なDCC-GARCH本格導入の条件**: ペーパートレーディング6ヶ月後、静的相関 vs EWMA相関 vs DCC-GARCHの事後比較を行い、動的モデルの追加的価値が確認できた場合に本格導入。Python `arch` パッケージでDCC-GARCHが実装可能。

---

### 3. ストレステストの定量的シナリオ拡充

#### 現状の問題

v2で4つのストレステストシナリオ（連続負け、市場ショック、長期低迷、複合シナリオ）を提案したが、いずれも「仮定ベース」の概算であり、実際のヒストリカルイベントに基づく再現テストではない。「VIXが40を超えた場合に5ポジション全てが-6%」という仮定は、2020年3月や2022年のインフレショックの実際のデータとどの程度整合するのか検証されていない。

#### 最悪のシナリオ

仮定ベースのストレステストで「最悪15-20%損失」と見積もったが、実際の2020年3月のデータを当てはめると、S&P500構成大型株の多くが1週間で-25%以上下落。当時の5ポジション想定シミュレーションでは、回路ブレーカーLevel 4（15%）を初日で突破し、さらに翌日-5%が追加。実損失は20-25%に達し、v2の想定を大きく超過。仮定ベースのストレステストが「最悪の中の最悪」を過小評価していた。

#### 改善提案

以下の具体的ヒストリカルイベントについて、strategy.mdのユニバース（S&P500大型株50-80銘柄）から5銘柄を選定し、実際のリターンデータを使ったシミュレーションを実施する。

**シナリオ1: 2020年3月 COVID-19パンデミックショック**

```
期間: 2020年2月19日（S&P500ピーク）〜 2020年3月23日（ボトム）
S&P500: -33.9%
VIX: 14→82（5.9倍）
想定ポジション: AAPL, MSFT, JPM, JNJ, XOM（5セクター分散）
検証項目:
  - 各銘柄の日次リターンで回路ブレーカー発動タイミング
  - ストップロス（ATR x 2.0）のスリッページ推定
  - ブラケット注文のlimit付きstopが機能したかの検証
  - 最終的な推定損失額
```

**シナリオ2: 2022年1-6月 インフレショック + 利上げサイクル**

```
期間: 2022年1月3日〜2022年6月16日
S&P500: -23.6%
VIX: 17→34
特徴: 急落ではなくジリ下げ。回路ブレーカーが発動しない「茹でガエル」パターン
想定ポジション: テクノロジー中心のポートフォリオ
検証項目:
  - 月次損失が10%に達するまでの期間
  - 段階的撤退メカニズム（10%→3ポジション、12%→1ポジション）の有効性
  - マクロレジーム判定（4変数モデル）がベアレジームを何日目に検出するか
```

**シナリオ3: 2023年3月 SVB（シリコンバレー銀行）危機**

```
期間: 2023年3月8日〜2023年3月15日（1週間）
特徴: セクター固有のショック（金融）が他セクターに波及
KBE（銀行ETF）: -28%
XLF（金融ETF）: -8.5%
XLK（テクノロジーETF）: -1.2%
想定ポジション: JPM, BAC, AAPL, MSFT, UNH
検証項目:
  - セクター集中リスクの実証（金融2銘柄のダメージ）
  - 相関リスクの波及パターン（金融→テクノロジーへの伝播）
  - 相関マトリクスの静的 vs 動的の差異
```

**シナリオ4: 2024年8月5日 日銀利上げ+円キャリーアンワインド**

```
期間: 2024年8月1日〜2024年8月8日
S&P500: -6.1%（8月5日単日で-3.0%）
VIX: 16→65（4.1倍、1日で）
特徴: 海外要因による突発的ショック、V字回復
想定ポジション: 標準的な5銘柄ポートフォリオ
検証項目:
  - 回路ブレーカーLevel 1（4%）の発動タイミング
  - Level 1発動後のクーリングオフ中にV字回復が始まる場合の機会損失
  - VIX連動ポジション制限（VIX > 30で新規停止）の発動速度
```

**シナリオ5: 2010年5月6日 フラッシュクラッシュ**

```
期間: 2010年5月6日 14:42-14:52（10分間）
S&P500: -9.2%（日中、終値ベースでは-3.2%）
特徴: 流動性枯渇による異常な価格変動
想定検証: ストップロスの成行注文が異常値で約定するリスク
検証項目:
  - limit付きstop order（提案済み）が機能したかの検証
  - limit価格の設定幅（ストップ価格の何%下に設定すべきか）
```

**実装**: Phase 0のバックテストフレームワークを拡張し、上記5シナリオのシミュレーションモジュールを追加する。結果はdocs/stress-test-results.mdに文書化。

---

### 4. limit付きstop orderの実装詳細 -- ストップ価格とリミット価格の乖離幅設定

#### 現状の問題

v2で「ストップロス注文にlimit price（最低約定価格）を設定し、フラッシュクラッシュ時の異常な安値約定を防止する」と提案し、action-plan.mdに反映された。しかし、ストップ価格とリミット価格の具体的な乖離幅が未設定のままだ。

この乖離幅の設定は、トレードオフの核心を含む。乖離幅が狭すぎると、急落時にリミット価格に達せず注文が未約定になり、ストップロスが機能しない（ポジションがオープンのまま損失が拡大）。乖離幅が広すぎると、limit付きの意味がなくなり、異常値での約定を防げない。

#### 最悪のシナリオ

**ケースA（乖離幅が狭すぎる）**: ストップ価格$100.00、リミット価格$99.50（乖離0.5%）。決算発表後のギャップダウンで始値が$95.00。リミット注文が$99.50以上でしか約定しないため、注文未約定。株価はさらに$90.00まで下落。ストップロスが「存在するが機能しない」最悪のパターン。損失は-10%。

**ケースB（乖離幅が広すぎる）**: ストップ価格$100.00、リミット価格$90.00（乖離10%）。フラッシュクラッシュで一時的に$85.00まで急落後、30分で$98.00に回復。リミット価格$90.00で約定してしまい、本来なら回復を待てた-2%の損失が-10%に確定。

#### 改善提案

1. **ATRベースの乖離幅設定**: 固定%ではなく、銘柄のボラティリティに連動させる。

```python
# limit付きstop orderの乖離幅設定
def calculate_stop_limit_prices(entry_price: float, atr: float) -> dict:
    stop_price = entry_price - (atr * 2.0)       # 通常のストップ価格
    limit_offset = atr * 1.0                       # リミット価格の乖離幅 = ATR x 1.0
    limit_price = stop_price - limit_offset        # リミット価格

    # 安全弁: リミット価格がエントリー価格の-8%を下回らない
    absolute_floor = entry_price * 0.92
    limit_price = max(limit_price, absolute_floor)

    return {
        "stop_price": round(stop_price, 2),
        "limit_price": round(limit_price, 2),
        "gap_pct": round((stop_price - limit_price) / stop_price * 100, 2)
    }
```

2. **乖離幅の根拠**: ATR x 1.0の乖離幅は、通常の取引日におけるビッド・アスクスプレッドの拡大幅をカバーする。ストレステスト（セクション3）で、この乖離幅が過去の急落イベントで約定率何%を達成するかを検証する。目標: 急落イベントの90%以上で約定し、かつフラッシュクラッシュ時の異常値（-20%以上）での約定を防止。

3. **未約定時のフォールバック**: limit付きstop orderが未約定の場合の対処。

```
未約定検出 → midday/eod実行時に以下を判断:
  (a) 株価がリミット価格以下で推移中 → 成行注文で即クローズ（損切り確定）
  (b) 株価がストップ価格-リミット価格の間 → 新しいlimit付きstop orderを再設定
  (c) 株価がストップ価格以上に回復 → 元のストップロスを維持

Reconciliationで未約定ストップロスを検出する仕組みをorder_executor.pyに追加。
```

4. **Alpaca APIでの実装**: ブラケット注文内のstop_lossにstop_priceとlimit_priceを両方設定可能か、APIドキュメントで確認が必要。stop_limit注文タイプが必要。

```python
from alpaca.trading.requests import LimitOrderRequest, StopLossRequest

order = LimitOrderRequest(
    symbol="AAPL",
    qty=100,
    side="buy",
    type="limit",
    limit_price=185.50,
    time_in_force="day",
    order_class="bracket",
    take_profit=TakeProfitRequest(limit_price=195.00),
    stop_loss=StopLossRequest(
        stop_price=180.00,
        limit_price=177.00  # ATR x 1.0の乖離幅
    ),
    client_order_id=f"{execution_id}_AAPL_buy"
)
```

---

### 5. VIX連動ポジション制限の閾値最適化 -- VIX 20/30の根拠と感度分析

#### 現状の問題

v2でVIX連動のポジション数制限（VIX < 20: 5ポジション、VIX 20-30: 3ポジション、VIX > 30: 新規禁止）を提案し、strategy.mdに反映された。しかし、閾値20と30の選定根拠が「経験則」に留まっており、過去データでの感度分析が行われていない。

VIX 20は「平常時の上限」として広く知られているが、2017年のように年間平均VIXが11の年もあれば、2022年のように年間平均VIXが25の年もある。固定閾値では市場のボラティリティ構造の変化に適応できない。

#### 最悪のシナリオ

**過敏すぎるケース**: 2022年のようにVIXが年間を通じて20-30の範囲で推移する年に、ほぼ常に3ポジション制限が適用される。5ポジションを前提とした年率8-12%のリターン目標が、3ポジション x 60%の資金効率で年率5-7%に低下。SPYに劣後し、撤退基準に抵触。VIX連動制限が「リスクを管理するための仕組み」ではなく「リターンを殺す仕組み」になってしまう。

**鈍感すぎるケース**: VIXが18→38に1日で急騰（2024年8月5日パターン）。朝の実行時（10:30 ET）にはVIX 22で3ポジション制限だが、既に5ポジション保有中。3ポジションへの縮小指示が出るが、市場が急落中のため縮小（=損切り）を実行。その後V字回復。VIX連動ルールに従ったことで、最悪のタイミングで2ポジションを損切りした。

#### 改善提案

1. **VIX閾値の感度分析**: 過去10年のVIXデータ（FRED: `VIXCLS`）を使い、以下の閾値パターンでバックテスト。

```
テスト閾値パターン:
  パターンA: 18/28（やや過敏）
  パターンB: 20/30（現行）
  パターンC: 22/35（やや鈍感）
  パターンD: 25/40（鈍感）

各パターンで測定:
  - ポジション制限が適用される日数の年間割合
  - 制限適用中の平均リターン vs 非適用中の平均リターン
  - ストレスイベント（月間-5%以上の下落）時の損失抑制効果
  - 年間リターンへの影響（機会損失の定量化）
```

2. **相対VIX（VIX/移動平均VIX）の導入**: 絶対値ではなく、VIXの相対的な位置で判定する。

```python
def get_vix_regime(current_vix: float, vix_ma_60d: float) -> str:
    """VIXの相対位置でレジーム判定"""
    vix_ratio = current_vix / vix_ma_60d

    if vix_ratio < 1.0 and current_vix < 25:
        return "low"       # 5ポジション
    elif vix_ratio < 1.5 or current_vix < 30:
        return "elevated"  # 3ポジション
    else:
        return "extreme"   # 新規エントリー禁止

    # 絶対値のフロアも維持（VIX > 35は問答無用で新規禁止）
```

3. **VIX変化率の考慮**: VIXの水準だけでなく、変化速度も判定に組み込む。VIXが1日で+50%以上急騰した場合は、水準に関わらず即座にポジション制限を発動。

```
VIXスパイク条件:
  - VIX日次変化率 > +50%: 即座に新規エントリー禁止（1営業日）
  - VIX日次変化率 > +30%: ポジション数を3に制限（1営業日）
  - 上記の解除: 翌営業日に再判定
```

4. **VIX/VIX3Mレシオ**: VIX先物のターム・ストラクチャーを監視。VIX/VIX3M > 1.0（バックワーデーション）はストレスの先行指標。

```
VIX/VIX3M > 1.0: 追加のリスク警告フラグ
  - ポジションサイズを通常の75%に縮小
  - 新規エントリーの確信度閾値を80%に引き上げ（通常70%）
```

---

### 6. 段階的撤退メカニズムの自動化設計

#### 現状の問題

v2で段階的撤退（10%ドローダウン→3ポジション制限+50%縮小、12%→1ポジション+冷却期間、15%→無期限停止）を提案し、strategy.mdとaction-plan.mdに反映された。しかし、「縮小」の具体的な実行方法が未設計だ。

問題は「5ポジション保有中に10%ドローダウンに達した場合、どの2ポジションをクローズするか」という判断ロジックだ。人間の判断に依存すれば、「この銘柄はもう少しで回復するはず」というバイアスが入る。planning-logでRISK自身が「人間の介入を物理的に不可能にする設計」を提案しているが、具体的なアルゴリズムが存在しない。

#### 最悪のシナリオ

10%ドローダウンに到達。システムが「3ポジションに縮小せよ」と指示。しかし、どのポジションをクローズするかのロジックがないため、LLMに判断を委ねる。LLMは「最も含み損が大きいポジションをクローズすべき」と判断（損失確定回避バイアスの裏返し）。実際には、最も含み損が大きいポジションこそリバウンド確率が高く、含み益のあるポジションを残した結果、その後さらに下落して12%に到達。撤退の順序を誤ったことで、回避可能な2%の追加損失が発生。

#### 改善提案

1. **機械的なポジション縮小アルゴリズム**: 人間の判断もLLMの判断も排除し、定量的なルールで縮小対象を決定する。

```python
def select_positions_to_close(positions: list, target_count: int) -> list:
    """縮小対象のポジションを機械的に選定"""
    if len(positions) <= target_count:
        return []

    n_to_close = len(positions) - target_count

    # スコアリング: 高スコアほど「クローズすべき」
    for pos in positions:
        pos.close_score = 0

        # (1) 保有期間がタイムストップに近い → クローズ優先
        days_held = (today - pos.entry_date).days
        if days_held > pos.time_stop_days * 0.8:
            pos.close_score += 3

        # (2) 含み損が大きい（ストップロスに近い） → クローズ優先
        loss_pct = (pos.current_price - pos.entry_price) / pos.entry_price
        if loss_pct < -0.03:  # -3%以上の含み損
            pos.close_score += 2

        # (3) セクター重複がある → 重複セクターから優先
        sector_count = sum(1 for p in positions if p.sector == pos.sector)
        if sector_count > 1:
            pos.close_score += 1

        # (4) 直近のLLMセンチメントがネガティブに転換 → クローズ優先
        if pos.latest_sentiment == "negative":
            pos.close_score += 2

    # スコア降順でソートし、上位n_to_close件をクローズ対象とする
    positions_sorted = sorted(positions, key=lambda p: p.close_score, reverse=True)
    return positions_sorted[:n_to_close]
```

2. **段階的撤退の自動実行フロー**:

```
毎回実行時（Step 5: リスクチェック）:
  1. High Water Markからのドローダウンを計算
  2. ドローダウン閾値に基づくアクション判定

  [10% <= DD < 12%]:
    - 保有ポジション > 3 の場合 → select_positions_to_close() で縮小
    - 新規エントリーのポジションサイズを50%に縮小
    - Slackアラート（WARN）
    - config.tomlの max_concurrent_positions を一時的に3に変更（DB記録）

  [12% <= DD < 15%]:
    - 保有ポジション > 1 の場合 → 最もclose_scoreが高いポジションから順次クローズ
    - 新規エントリー完全停止
    - 1週間の冷却期間をcircuit_breakerテーブルに記録
    - Slackアラート（ERROR）

  [DD >= 15%]:
    - 全ポジションを成行注文でクローズ
    - 無期限停止フラグをDBに設定
    - Slackアラート（CRITICAL）
    - trading_agent.pyの冒頭でフラグをチェックし、即終了
```

3. **冷却期間後の復帰条件**: 12%ドローダウンで1週間停止した後、復帰条件を明確化。

```
復帰条件（全て満たすこと）:
  - 冷却期間（7営業日）が経過
  - VIX < 25（市場環境が安定）
  - 直近5営業日のSPYリターンが > 0%（市場が回復基調）
  - 復帰後のポジション上限は1（段階的に2→3→5と緩和、各2週間）
```

---

### 7. リアル移行時の「厳格化された回路ブレーカー」の実運用シミュレーション

#### 現状の問題

v2のaction-plan.mdで「リアル移行時の回路ブレーカー厳格化: 全閾値を50%に引き下げ（Level 1: 2%, Level 2: 3.5%, Level 3: 5%, Level 4: 10%）」と提案し反映された。しかし、この厳格化された閾値がペーパートレーディングの実績データに対してどの程度の頻度で発動するかの事前シミュレーションが行われていない。

Level 1が2%というのは、5ポジション x 平均0.5%の日次変動が全て同方向に動いただけで2.5%に達する。これは月に数回、場合によっては週に1回以上発動する可能性がある。Level 1の頻繁な発動は新規エントリー機会の喪失を意味し、リターンを大幅に毀損する。

#### 最悪のシナリオ

リアル移行Stage 1（資金10%）で厳格化された回路ブレーカーを適用。Level 1（2%）が最初の2週間で3回発動。クーリングオフ期間48時間が重なり、月の半分以上で新規エントリーが不可能に。結果、20取引の最低条件を2ヶ月で達成できず、Stage 2への移行が遅延。さらに、Level 1発動 → 48時間後に解除 → 翌日再発動 → Level 2エスカレーション（3.5%）→ 全ポジションクローズ → 3営業日50%縮小の連鎖で、リアル移行開始早々に縮小運用に追い込まれる。ペーパーでは問題なかった戦略が、閾値厳格化のせいで機能しなくなる「制度が戦略を殺す」パターン。

#### 改善提案

1. **ペーパートレーディング実績を使った事前シミュレーション**: ペーパートレーディング6ヶ月分の日次PnLデータに対して、厳格化された閾値を遡及的に適用し、発動頻度をカウントする。

```
シミュレーション手順:
  1. ペーパートレーディングの日次PnL系列（6ヶ月分）を取得
  2. 閾値パターンA（2%/3.5%/5%/10%）とパターンB（3%/5%/7.5%/12%）を適用
  3. 各パターンで以下を計測:
     - Level 1の月間発動回数
     - Level 2の月間発動回数
     - 新規エントリー不可能日数の割合
     - 年率リターンへの影響（発動なし vs 発動あり）
  4. 最適な閾値を選定

目標: Level 1の発動が月2回以下、Level 2は四半期1回以下
```

2. **段階的厳格化**: 一気に50%引き下げではなく、リアル移行Stageに応じた段階的厳格化。

```
| Stage     | Level 1 | Level 2 | Level 3 | Level 4 | 根拠                      |
|-----------|---------|---------|---------|---------|---------------------------|
| ペーパー  | 4%      | 7%      | 10%     | 15%     | 現行                      |
| Stage 1   | 3%      | 5%      | 7.5%    | 12%     | 75%に引き下げ             |
| Stage 2   | 2.5%    | 4.5%    | 6%      | 10%     | 62.5%に引き下げ           |
| Stage 3-4 | 2%      | 3.5%    | 5%      | 10%     | 50%に引き下げ（最終形）   |
```

3. **リアル移行専用の「観察モード」**: Stage 1の最初の2週間は、回路ブレーカーを「観察モード」（発動条件に達してもログとアラートのみ、実際のクローズは行わない）で運用し、発動頻度の実データを収集してから閾値を調整。

---

### 8. テールリスクヘッジ -- プロテクティブプットのコスト対効果の定量分析

#### 現状の問題

v2で「プロテクティブプットの検討（コスト分析が必要）。初期段階ではコスト面から非現実的」と記載したが、定量的なコスト分析自体を行っていない。「非現実的」という結論は直感に基づいており、実際にどの程度のコストがかかり、どの程度の損失を回避できるかの比較がない。

ペーパートレーディングではオプション取引はテストできないが、Phase 0のバックテストでコスト対効果を定量的に評価することは可能であり、リアル移行時の判断材料として事前に分析しておくべきだ。

#### 最悪のシナリオ

「コスト面から非現実的」と判断してテールリスクヘッジを完全に放棄。リアル移行後、2020年3月型のショックが発生。5ポジション全てが-10%以上。回路ブレーカーLevel 4が発動し、プロジェクト停止。プロテクティブプットを保有していれば、$500のプレミアムコストで$5,000の損失を回避できた。コスト対効果の定量分析なしに「非現実的」と判断したことが、プロジェクト致命傷の直接原因。

逆のシナリオも同様に危険だ。テールリスクを恐れて毎月プロテクティブプットを購入し続け、プレミアムコストが年間リターンの3-5%を侵食。ショックが起きなかった年に「保険のかけすぎ」でSPYに大幅劣後。いずれのケースも、定量分析なしの判断が原因。

#### 改善提案

1. **SPYプットのコスト分析**: 個別株のプットではなく、ポートフォリオ全体のヘッジとしてSPYプットのコストを分析。

```
分析条件:
  ポートフォリオ: $10,000（初期資金想定）
  ヘッジ対象: ポートフォリオの80%（$8,000相当のSPYプット）
  プット権利行使価格: SPY現在値の-5%（OTM）
  期間: 1ヶ月

推定コスト（VIX水準別）:
  VIX 15: 月額 $40-60（年率4.8-7.2%のリターン低下）
  VIX 20: 月額 $60-90（年率7.2-10.8%のリターン低下）
  VIX 25: 月額 $90-130（年率10.8-15.6%のリターン低下）

結論:
  - VIX < 20の平常時は、プロテクティブプットのコストが年率リターン目標
    （8-12%）の大部分を侵食するため「非現実的」は正しい
  - ただし、以下の限定的ヘッジは検討に値する
```

2. **限定的テールリスクヘッジ戦略**: 常時ヘッジではなく、特定条件下でのみヘッジ。

```
ヘッジ発動条件:
  (a) VIX/VIX3M > 1.0（バックワーデーション = ストレス先行指標）
  (b) リアル移行Stage 3以降（資金50%以上）
  (c) 決算集中期（S&P500の20%以上が同週に決算発表）

ヘッジ手段:
  - SPYプット（権利行使価格: -7%OTM、期間: 2週間）
  - コスト上限: 月間リターンの1%以内
  - VIX > 25の場合はプレミアムが高騰するため、VIX < 20の時に事前購入

年間推定ヘッジコスト: 年4-6回 x $30-50 = $120-300（年率1.2-3.0%）
```

3. **コスト対効果のバックテスト**: 過去10年のSPYオプションデータ（CBOE）を使い、上記ヘッジ戦略の損失回避効果を検証。

```
検証項目:
  - ヘッジありの最大ドローダウン vs ヘッジなしの最大ドローダウン
  - ヘッジコスト累計 vs ヘッジによる損失回避額
  - ヘッジありのシャープレシオ vs ヘッジなしのシャープレシオ
  - 「ヘッジが利益を生んだ回数」/ 「ヘッジを実行した回数」= ヒット率
```

4. **実装時期**: Phase 0-4（ペーパー期間）ではオプション取引テスト不可のため、コスト分析のみ実施。リアル移行Stage 2以降で実装を検討。Alpaca APIがオプション取引をサポートしているかの確認が前提条件。

---

## 最終提言（優先順位付き3項目）

### 1. ストレステストの実データ再現と回路ブレーカーのキャリブレーション（最優先）

v2で骨格を設計した回路ブレーカーと段階的撤退メカニズムは、「仮定ベースの数値」で構成されている。最悪のシナリオは？ -- **閾値が実際の市場動態に適合しておらず、「過敏すぎて戦略を殺す」か「鈍感すぎて損失を防げない」かのどちらかに陥ること**だ。Phase 0のバックテストデータを活用し、5つのヒストリカルシナリオ（COVID-19、インフレショック、SVB危機、円キャリー巻き戻し、フラッシュクラッシュ）で実データ再現テストを実施すべき。結果に基づき、回路ブレーカー閾値（ペーパー版 / リアル版）をキャリブレーションする。

**実施時期**: Phase 0と並行（Week 1-2）
**成果物**: docs/stress-test-results.md

### 2. 動的相関管理と段階的撤退の自動化アルゴリズム設計（構造的改善）

月次更新の静的相関マトリクスでは、危機時の相関収束に対応できない。EWMA相関（日次更新）と相関ブレイクアウト警告を実装し、相関レジームに応じたポジション上限の動的切り替えを導入すべき。同時に、段階的撤退メカニズムの「どのポジションをクローズするか」という判断を、機械的なスコアリングアルゴリズムで自動化する。人間の判断もLLMの判断も排除し、感情バイアスが介入する余地をゼロにする。

**実施時期**: Phase 2（Week 5-6）のリスク管理モジュール実装時
**成果物**: modules/risk_manager.pyに組み込み

### 3. ギャップリスクの確率分布推定とlimit付きstop orderの乖離幅最適化（防御の精緻化）

v2のスリッページバッファ30%は「根拠のない安全マージン」だ。最悪のシナリオは？ -- **30%が過小で、決算ギャップダウンの実態をカバーしていないこと**。Phase 0の決算データ4,000件からギャップ分布を推定し、イベント種別ごとの適切なバッファ係数を算出すべき。同時に、limit付きstop orderのストップ-リミット乖離幅をATRベースで設定し、「ストップロスが存在するが機能しない」最悪パターンを防止する。

**実施時期**: Phase 0（Week 1-2）のデータ分析と並行
**成果物**: config.tomlにイベント種別ごとのスリッページ係数テーブルを追加

---

> 最悪のシナリオは？ -- **「リスク管理の仕組みは全て揃っているが、パラメータが現実に適合しておらず、仕組みが空振りする」**。v2で防御の骨格を作った。v3ではその骨格に血を通わせる -- 実データに基づくキャリブレーション、動的な適応メカニズム、そして人間の判断を排除した機械的実行。リスク管理は設計で終わるのではなく、市場データとの継続的なフィードバックループで初めて機能する。
