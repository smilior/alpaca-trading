# トレーディング戦略ドキュメント v3

## エグゼクティブサマリー

LLMの自然言語理解力を活用し、ニュース・決算レポートのセンチメント分析をプライマリシグナル、テクニカル指標をフィルターとするハイブリッドスイングトレード戦略。S&P500大型株を対象に、cron + Claude CLIで日次自動実行する。目標はフェーズに応じた段階的設定とし、最終目標としてシャープレシオ0.8以上、[v3変更] 取引コスト込みネットリターン年率6-10%（SPY+α）を目指す。コード実装前にLLMセンチメント精度のベースラインを確立し、alpha仮説の事前検証（Phase 0）を必須とする。[v3変更] MVP思想を導入し、初期3ヶ月は最小限の実装で運用を開始、複雑な機能は運用データが必要性を証明した場合にのみ追加する。

---

## 0. Phase 0: alpha仮説の事前検証

> **原則: コードを1行も書く前に仮説を検証せよ。**

### 目的

LLMセンチメント分析がトレーディングalphaを生むという中核仮説を、システム構築前に定量的に検証する。検証なしにコード実装を始めてはならない。

### [v3変更] 検証手順（精緻化された実行プロトコル）

```
Step 0: プロンプト設計（Day 1-2）★v3新規★
  - 本番用プロンプト（prompts/trading_decision.md）のv1.0をフリーズ
  - Phase 0専用のラッパープロンプトを作成:
    「以下の決算情報のみに基づいて判断せよ。
     株価の事後的な動きに関する知識は使うな。
     判定日は {earnings_date} として扱え。」
  - プロンプトにタイムスタンプ制約を明示的に含める
  - プロンプト3種類（簡潔版、詳細版、Chain-of-Thought版）を用意し、
    全てでFinBERT/VADERを上回ることを要求

Step 1: データ収集（Day 3-5）
  - ソース: SEC EDGAR（10-Q/10-K）+ Alpaca News API（決算プレスリリース）
  - 対象: S&P500構成銘柄のうちユニバース条件を満たす銘柄
  - [v3変更] サンプリング: 層化抽出法
    - 11セクター x 各18件 = 198件（端数調整で200件）
    - 各セクター内ではランダム選定
    - 期間: 直近2年（8四半期分をカバー）
  - データ項目: 決算プレスリリース全文、EPS実績/予想、売上実績/予想、
    ガイダンス（あれば）、発表日翌1/3/5営業日のリターン
  - 除外条件: M&A発表と決算が同日の銘柄（ノイズ排除）
  - 大規模検証用: 4,000件 x $0.03 = $120

Step 2: LLMセンチメント分析実行（Day 6-8）
  - 各決算レポートに対してClaude CLIでセンチメント分析を実行
  - 出力: {sentiment: positive/negative/neutral, confidence: 0-100,
    key_drivers: [...], risk_factors: [...]}
  - コスト: 200件パイロット x ~$0.03 = ~$6
  - 実行ログ: 全入力・全出力をJSON保存（再現性確保）
  - バッチ実行: 10件ごとにdelay、50件ごとにJSON中間保存（リジューム対応）

Step 3: 時間バイアス検定（Day 9）★v3新規★
  - 検証方法: 20件の「未来データ」テスト
    - 直近1週間に発表された決算（LLMのトレーニングデータに含まれない可能性が高い）
    - この20件の精度と、過去データ200件の精度を比較
    - 有意な差（>10pp）があれば時間バイアスの存在を示唆
  - 差がある場合: 過去データの精度に「時間バイアス割引」を適用
    補正精度 = 過去精度 - (過去精度 - 直近精度) * 0.5

Step 4: ベースライン比較（Day 10-12）
  - FinBERT: 同一200件で実行（ローカル、無料）
  - VADER: 同一200件で実行（ローカル、無料）
  - ナイーブモデル: 「常にポジティブ」「EPS beatなら常にポジティブ」
  - [v3変更] 比較: McNemar検定（ペアデータのため、χ二乗検定より適切）
  - [v3追加] Brier Score（キャリブレーション品質の定量指標）
  - [v3追加] 効果量: Cohen's kappa（モデル間の一致度）

Step 5: Go/No-Go判断（Day 13-14）
```

### 測定指標

| 指標 | 定義 | 合格基準 |
|------|------|----------|
| 方向性精度 | (ポジティブ判定&株価上昇 + ネガティブ判定&株価下落) / 全判定数 | [v3変更] >= 65% |
| 確信度加重精度 | Σ(確信度 x 正解フラグ) / Σ確信度 | >= 55% |
| FinBERT/VADERとの差 | LLM精度 - ベースライン精度 | >= +5% |
| [v3変更] 統計検定 | McNemar検定（LLM vs FinBERT） | p < 0.05 |
| [v3追加] Brier Score | 確信度のキャリブレーション品質 | < 0.25 |

### ゴールドスタンダード（正解ラベル）の定義

```
事後ラベル方式: エントリー後5営業日のリターンで判定
  - ポジティブ正解 = 5日後リターン > +1%
  - ネガティブ正解 = 5日後リターン < -1%
  - 中立正解 = -1% <= 5日後リターン <= +1%
  注: 閾値の+/-1%自体も感度分析の対象とする（0.5%, 1.0%, 1.5%, 2.0%）
```

### [v3変更] 判定基準（Go/No-Go基準の厳格化）

> **DEVILの指摘を受けて**: 60%でGoとした場合、取引コスト控除後にリターンがマイナスになる可能性が高い。Go基準を65%に引き上げ。

```
判断マトリクス（境界ケース対応）:
  | LLM精度      | vs FinBERT差  | 判断               |
  |-------------|--------------|---------------------|
  | >= 70%      | >= +5pp      | Go（確信的）         |
  | >= 65%      | >= +5pp      | Go（慎重に）         |
  | >= 65%      | < +5pp       | 条件付Go: 追加200件で再検証 |
  | 60-64%      | >= +10pp     | 条件付Go: 追加200件で再検証 |
  | < 60%       | any          | No-Go               |

  条件付Goの場合: 追加200件（コスト$6）で再検証し、
  合計400件で上記基準を再判定。2回目も条件付ならNo-Go。

追加条件★v3新規★:
  - Go判定の前に「取引コスト控除後の期待リターンがプラス」であることを
    数式で確認すること
  期待リターン/トレード = 精度 x E[win] - (1-精度) x E[loss] - 取引コスト
  この値がプラスでなければ、精度65%以上でもGo判定を出してはならない
```

### エッジサイズの定量化

```
[v3変更] 取引コスト込み期待リターン計算:
  取引コスト（往復）:
    - スプレッドコスト: 0.03% x 2 = 0.06%
    - スリッページ: 推定0.04%
    - 合計: 約0.10%/トレード

  シナリオ別リターン早見表★v3新規★:
  | 勝率  | RR比 | 年間取引数 | 取引コスト | 年率ネットリターン（概算） |
  |------|------|----------|----------|----------------------|
  | 55%  | 1.5  | 80       | 1.5%     | 3.0-4.5%             |
  | 55%  | 2.0  | 80       | 1.5%     | 5.5-7.0%             |
  | 60%  | 1.5  | 80       | 1.5%     | 6.0-8.0%             |
  | 60%  | 2.0  | 80       | 1.5%     | 9.0-11.0%            |
  | 60%  | 2.0  | 120      | 2.0%     | 11.0-14.0%           |
  | 65%  | 1.5  | 80       | 1.5%     | 9.5-12.0%            |

  → Phase 0の結果がいずれのシナリオにも該当しない場合、
    目標リターンを再引き下げるか、テイクプロフィット幅を調整
```

### [v3新規追加] Phase 0 バックテストコード骨格

```python
# phase0/backtest_sentiment.py -- Phase 0 バックテスト骨格

# Step 1: データ収集
def collect_earnings_data(start_date, end_date) -> pd.DataFrame:
    """yfinance + Alpaca News APIで決算データ収集"""
    # カラム: symbol, earnings_date, eps_actual, eps_estimate,
    #         revenue_actual, revenue_estimate, return_day1_pct,
    #         return_day5_pct, gold_label

# Step 2: LLMセンチメント分析（バッチ実行）
def run_llm_sentiment_batch(earnings_df, prompt_template,
                            batch_size=10, max_retries=3):
    """Claude CLIでバッチ実行。50件ごとに中間保存、リジューム対応"""

# Step 3: ベースライン比較
def run_finbert_baseline(texts) -> list[dict]:
    """ProsusAI/finbert、ローカル実行"""

def run_vader_baseline(texts) -> list[dict]:
    """vaderSentiment、ローカル実行"""

# Step 4: 統計検定
def compare_models(llm_results, finbert_results, vader_results, gold_labels):
    """McNemar検定 + Brier Score + Cohen's kappa"""

# Step 5: Go/No-Goレポート自動生成
def generate_phase0_report(metrics, output_path):
    """取引コスト込み期待リターンを含むGo/No-Go判定レポート"""
```

### [v3新規追加] LLM比較実験プロトコル

```
比較実験の公正性担保:
1. 入力データの統一:
   - 全モデルに同一のニューステキストを入力
   - FinBERT: 512 tokensに切断（モデル制限）
   - VADER: フルテキスト
   - LLM: フルテキスト（最大2,000 tokens）

2. 出力形式の統一:
   {
     "label": "positive" | "negative" | "neutral",
     "confidence": 0.0-1.0,
     "raw_output": { ... }
   }

3. LLMのプロンプト3種類で全てFinBERT/VADERを上回ることを要求
   最低1つのバリエーションで有意差が出なければ、
   LLMのエッジは「プロンプトに過剰適合」と判断

4. サンプルサイズ: McNemar検定で効果量10%を検出するために最低200件
```

---

## 1. 戦略の概要

### 何を売買するか

- **主要対象**: S&P500構成銘柄のうち、流動性条件を満たす大型株 50-80銘柄（シグナル頻度確保のため拡大）
- **補完対象**: セクターETF（XLK, XLV, XLF, XLE等）セクターモメンタム戦略として明確化（セクション8参照）
- **銘柄選定条件**:
  - 日次平均出来高: 100万株以上
  - ビッド・アスクスプレッド: 0.05%以内
  - 時価総額: $10B以上
  - セクター分散: 同一セクター最大2銘柄（テクノロジーのみ最大3銘柄。サブセクター分散を考慮）
  - アナリストカバレッジ: 5人以上
  - ATRパーセンタイル: 上位50%（ボラティリティが十分ある銘柄に限定）
  - Earnings Surprise History: 過去4四半期のサプライズ頻度が50%以上
  - Institutional Ownership: 30-80%

### いつ売買するか

- **時間軸**: スイングトレード（イベント種別ごとに保有期間を設定。詳細はセクション4参照）
- **最小保有期間**: 2営業日（チャーン防止。ただしテイクプロフィット到達時は即利確）
- **cron実行スケジュール**（米国東部時間）:
  - 09:30 ET: プレマーケット分析・ニュース収集
  - 10:30 ET: モーニングエントリー判断
  - 13:00 ET: ミッドデイリスクチェック
  - 15:30 ET: EODクロージング判断
- **決算発表日**: 追加実行（発表後30分、翌朝09:30）

### どう売買するか

- **エントリー**: 階層フィルター方式（LLMセンチメント分析 → テクニカルフィルターでランキング → 上位銘柄のみエントリー）
- **エグジット**: 利益確定（テイクプロフィット）またはストップロス、時間減衰ストップ、または保有期間超過
- **注文方法**: ブラケット注文（OTO: One-Triggers-Other）を使用。エントリー約定時に自動でストップロスとテイクプロフィットを発注。[v3変更] ストップロスにはlimit付きstop order（stop_limit注文）を使用
- **1日の最大新規エントリー**: 2ポジション

---

## 2. LLMを使う理由と優位性

### 従来のアルゴリズムトレーディングとの差別化

| 観点 | 従来のアルゴ | LLMハイブリッド戦略 |
|------|------------|-------------------|
| データソース | 構造化データ（価格・出来高）のみ | + 非構造化データ（ニュース・決算・FRB声明） |
| センチメント分析 | ルールベース（VADER等）、文脈理解なし | LLMによる文脈付きニュアンス判定 |
| 戦略変更 | コードの書き換えが必要 | プロンプト変更で即時対応 |
| コスト | 開発工数大 | $0.03/回で分析可能 |
| 適応性 | パラメータ再最適化が必要 | プロンプトで新しい市場環境に適応 |

### LLMの具体的な優位性

1. **決算レポートの文脈理解**: 「Revenue beat expectations but guidance was lowered due to one-time charges」のようなニュアンスを正確に判定
2. **マルチファクター統合判断**: テクニカル指標 + ニュースセンチメント + マクロ環境を自然言語で統合
3. **コスト効率**: 低コストでの自然言語分析（ただし精度はPhase 0で検証必須）

### 差別化要因の再定義

> **核心的エッジ**: LLMセンチメント単体ではなく、「決算発表直後のLLMセンチメントと市場反応の乖離」にフォーカスする。LLMが「ポジティブ」と判定しつつ市場が初日に大幅下落するケースに、検証可能なミスプライシングの可能性がある。

**注意事項**:
- LLMセンチメント分析はコモディティ化しつつある。先行者利益の窓は狭い
- [v3変更] これは「注意書き」ではなく、プロジェクトの存在意義に関わる根本問題（alpha decayフレームワーク: セクション11参照）
- 「$0.03でプロアナリスト級」は過大な主張。LLMが持つのは公開テキストの分析能力であり、非公開情報や業界人脈に基づく判断は含まない
- S&P500大型株は世界で最も分析されている銘柄群であり、情報の非効率性は小さい
- [v3追加] LLMの価値は「正確さ」だけでなく「コンセンサスとの差異」にある。アナリストコンセンサスとLLM判定の乖離度が大きいケースにエッジが集中する可能性がある

### 仮説

> 決算発表後、LLMが「ポジティブ」と判定したにもかかわらず株価が初日に-2%以上下落した銘柄は、5営業日以内にリバウンドする確率が高い。なぜなら、アルゴリズムトレーダーの初期反応がネガティブなヘッドラインに過剰反応し、ファンダメンタルズに基づく修正が後から起きるためだ。

**学術的根拠（PEAD: Post-Earnings Announcement Drift）**:
- Ball & Brown (1968): PEADの初期発見
- Bernard & Thomas (1989): PEADの60日持続性
- Brandt et al. (2008): ボラティリティ条件付きPEAD
- DeHaan et al. (2015): メディアカバレッジとPEADの関係（本戦略に直接関連）
- [v3追加] McLean & Pontiff (2016): 学術論文発表後にアノマリーの平均リターンが58%縮小（alpha decayの根拠）

**仮説の多次元拡張**:
- 「売上成長 vs ガイダンス」の方向一致度
- 「一時的要因 vs 構造的要因」の判別
- 「アナリストコンセンサス vs LLM判定」の乖離度（乖離が大きいほどミスプライシングの可能性）

**フェイルセーフ**: LLMポジティブ+初日-2%のシグナルが出ても、翌日にさらに-2%下落した場合はエントリーを見送る（モメンタム継続の可能性。「落ちるナイフを掴む」リスクの低減）。

---

## 3. 対象銘柄・セクター

### 銘柄ユニバース構築基準

ユニバースを50-80銘柄に拡大。シグナル頻度を年間30-50件に引き上げる。

```
スクリーニング条件:
1. S&P500構成銘柄
2. 日次平均出来高 >= 1,000,000株（20日平均）
3. ビッド・アスクスプレッド <= 0.05%
4. 時価総額 >= $10B
5. 直近1年間の株価データが完全に取得可能
6. アナリストカバレッジ >= 5人
7. ATRパーセンタイル >= 50%（過去20日ATR基準）
8. Earnings Surprise History: 過去4四半期中2回以上のサプライズ
9. Institutional Ownership: 30-80%
```

### [v3新規追加] 銘柄ユニバース段階的拡大プロトコル

```
定義の統一:
  - 「シグナル頻度」= Stage 2通過後の最終エントリーシグナル数/月
  - 「シグナル品質」= エントリー後5日リターンの平均値

拡大判断マトリクス★v3新規★:
  | 月間シグナル数 | シグナル品質   | 判断                |
  |-------------|-------------|---------------------|
  | >= 12       | >= +0.5%    | 現状維持（十分）       |
  | >= 8        | >= +0.5%    | 現状維持             |
  | >= 8        | < +0.5%     | 拡大せず、フィルター見直し |
  | 5-7         | >= +0.5%    | 拡大検討（下記手順）    |
  | < 5         | any         | 即時拡大             |

拡大手順:
  1. 追加候補銘柄をスクリーニング（ユニバース条件準拠）
  2. 候補銘柄を以下の優先順位でランキング:
     a. 過去4四半期のEarnings Surprise頻度（高い方が上位）
     b. ATRパーセンタイル（高い方が上位）
     c. 決算発表日が次の決算シーズンと重ならない（分散効果）
  3. 上位20銘柄を追加（30→50）
  4. 2ヶ月運用後に再評価

逆戻り条件★v3新規★:
  - 拡大後2ヶ月の追加銘柄群の平均シグナル品質が、
    既存銘柄群の平均シグナル品質を1pp以上下回る場合:
    → 下位パフォーマンス銘柄10銘柄を除外
  - 拡大後の全体シグナル品質が拡大前を下回る場合:
    → 拡大前のユニバースに戻す

評価タイミング:
  - 初回判断: 2ヶ月目終了時（1ヶ月目はデータ不足）
  - 以後: 毎月末の月次チェックポイントで評価
```

### セクター配分ガイドライン

テクノロジーを最大3銘柄に緩和。サブセクター分散を考慮。

| セクター | 代表ETF | 最大配分比率 | 最大同時ポジション |
|----------|---------|------------|-------------------|
| テクノロジー | XLK | 30% | 3（サブセクター分散を条件とする） |
| ヘルスケア | XLV | 20% | 2 |
| 金融 | XLF | 20% | 2 |
| 一般消費財 | XLY | 15% | 1 |
| 通信サービス | XLC | 15% | 1 |
| その他 | - | 20% | 1 |

**サブセクター分散ルール**: テクノロジー3銘柄の場合、ソフトウェア/半導体/ハードウェアの異なるサブセクターから選定すること（サブセクター間相関 ≈ 0.6で、同一サブセクター内相関 ≈ 0.85より低い）。

### マクロレジーム判定（4変数モデル）

4変数モデルに拡張し、レジーム遷移の早期検出を追加。

| 変数 | データソース | ブル | レンジ | ベア |
|------|------------|------|--------|------|
| S&P500 vs 200日MA | Alpaca | 上 | 近辺(+/-2%) | 下 |
| VIX | FRED | < 18 | 18-25 | > 25 |
| イールドカーブ (10Y-2Y) | FRED (`T10Y2Y`) | > 0 (正常化) | -0.5 to 0 | < -0.5 (逆転) |
| クレジットスプレッド (HY-IG) | FRED (`BAMLH0A0HYM2`) | < 350bp | 350-500bp | > 500bp |

**判定ロジック**: 4変数中3つ以上が同一レジームなら確定。2:2なら「レンジ」扱い。

[v3変更] **段階的アプローチ（MVP方針に従い）**:
- Phase 1-3: 等加重投票方式を維持（データドリブンの重み最適化には最低12ヶ月のデータが必要。少ないデータでの最適化はオーバーフィッティングの温床）
- Phase 4以降: データドリブン重み付けへの移行を検討（ロジスティック回帰で各変数の予測寄与度を分析）

| レジーム | 戦略 |
|----------|------|
| ブル相場 | 通常運用。ロングのみ |
| レンジ相場 | ポジションサイズ50%に縮小 |
| ベア相場 | 新規エントリー停止。既存ポジションのみ管理 |

### [v3新規追加] レジーム遷移のヒステリシス（遅延確定）

```
問題: 2:2判定が日替わりで変動し、ポジションサイズが不安定になる
対策:
  - レジーム確定には「3営業日連続で同一判定」を要求
  - 遷移中（未確定）はレンジ扱い（ポジションサイズ50%縮小）を維持
  - レジーム変更ログをDBに記録し、変更頻度を月次でモニタリング
  - 月間レジーム変更が4回以上 → 閾値の再キャリブレーションを実施
```

### [v3新規追加] データ遅延への対処

```
  - クレジットスプレッド: ICE BofAデータ（FRED経由）は1-2日遅延
  - 対策: 遅延データにはフラグを立て、遅延2日以上の場合は
    該当変数を投票から除外（3変数中2以上で判定）
```

**セクターモメンタム**: XLK/XLV/XLF/XLE/XLYの20日リターンを追跡し、「リーダーセクター」と「ラガードセクター」を特定。エントリーはリーダーセクターに属する銘柄を優先。

**レジーム遷移の早期検出**: 50日MAと200日MAのゴールデンクロス/デッドクロスを監視し、遷移シグナルを1-2ヶ月前倒しで検出。レジーム遷移中はポジションサイズを自動50%縮小。

**FRED APIから追加取得すべき指標**:
- `T10Y2Y`: 10年-2年イールドスプレッド
- `BAMLH0A0HYM2`: BofA MLハイイールドスプレッド
- `ICSA`: 新規失業保険申請件数（4週移動平均）
- `UMCSENT`: ミシガン消費者信頼感指数

---

## 4. エントリー・エグジット条件

### エントリー条件（階層フィルター方式）

```
Stage 1: LLMセンチメントフィルター（候補銘柄の選定）
  - LLMセンチメント分析 = "ポジティブ"（確信度 >= 70%）
  → 候補銘柄リストを生成

Stage 2: テクニカルフィルターでランキング
  [v3変更] tech_scoreの正規化手法を明示
  tech_score = w_ma * percentile_rank(ma_distance)
             + w_rsi * percentile_rank(rsi_neutral_score)
             + w_vol * percentile_rank(volume_ratio)

  正規化手法: パーセンタイルランク（推奨）
  理由:
    1. 外れ値に頑健
    2. 分布の形状に依存しない
    3. 解釈が容易（「上位20%以内」等）
    4. 銘柄数30-80の範囲で十分な解像度がある

  [v3変更] 重み付け: 等重みでスタート (0.33, 0.33, 0.34)
  6ヶ月運用後にMutual Information分析（セクション7参照）に基づいて
  1回だけ調整。初期段階で重み最適化はオーバーフィッティングの温床。

  条件:
  - 株価が50日移動平均線の上にある
  - RSI(14) < 70（過熱排除のみ。下限30の制約を撤廃）
  - 当日の出来高が20日平均出来高を上回る

Stage 3: リスクフィルター（絶対条件）
  - マクロレジームがベア相場でない
  - 同時ポジション数が上限未満（VIX連動。セクション5参照）
  - 同一セクターのポジション数が制限未満
  - 当日の新規エントリーが2未満

Stage 4: エントリー判定
  - tech_score上位銘柄からエントリー

確信度による条件緩和:
  - 確信度 >= 90%: テクニカル条件2/3満たせばOK
  - 確信度 >= 80%: テクニカル条件3/3必須
  - 確信度 >= 70%: テクニカル条件3/3 + セクターモメンタム上位
```

**RSI条件の修正理由**: 旧条件のRSI 30-70は、決算オーバーリアクション仮説（ポジティブ判定なのに-2%下落した銘柄のリバウンド）と矛盾していた。RSI<30の銘柄こそターゲットになりうるため、下限を撤廃し「RSI < 70（過熱排除のみ）」に変更。

### [v3新規追加] シグナル間のMutual Information分析

```
Phase 0の4,000件データで以下のMI分析を実施:

1. 各シグナルソースと5日後リターンの相互情報量:
   MI(LLM_sentiment, return_5d) = ?
   MI(ma_distance, return_5d) = ?
   MI(rsi, return_5d) = ?
   MI(volume_ratio, return_5d) = ?

2. シグナル間の相互情報量（冗長性チェック）:
   MI(LLM_sentiment, ma_distance) = ?
   MI(LLM_sentiment, rsi) = ?
   MI(LLM_sentiment, volume_ratio) = ?

3. Conditional Mutual Information:
   CMI(tech, return | LLM) = MI(tech, return | LLM_sentiment)
   CMI ≈ 0: テクニカルはLLM以上の情報を持たない → フィルターから除外検討
   CMI > 0: テクニカルはLLMの補完的情報を持つ → フィルターとして有効

4. 結果に基づくフィルター設計の最適化:
   - CMI(tech|LLM) ≈ 0のテクニカル指標はフィルターから除外
   - 例: volume_ratioのCMIが低い場合、2条件に簡素化
     → シグナル数が推定で30-40%向上

実装: sklearn.feature_selection.mutual_info_regression()
追加コスト: $0（Phase 0の既存データを再利用）
```

### エグジット条件（いずれか1つ）

```
OR条件（いずれか1つで発動）:
1. [利確] テイクプロフィット発動（ATR連動。詳細は下記）
2. [損切] ストップロス発動（多層構造。詳細は下記）
3. [時間減衰] 保有5日経過後に含み益がATR x 1.0未満 → クローズ
4. [期限] イベント種別ごとの保有期間上限を超過 → タイムストップ
5. [反転] LLMセンチメント分析が "ネガティブ" に転換（確信度 >= 80%）
6. [緊急] 回路ブレーカー発動
```

### テイクプロフィット（ATR連動化）

```python
# ATR連動テイクプロフィット
take_profit_price = entry_price + (ATR_14 * 3.0)
# リスクリワード比 = (ATR x 3.0) / (ATR x 2.0) = 1.5
# ボラティリティの高い銘柄には広いターゲット、低い銘柄には狭いターゲット
```

### ストップロス（多層構造）

```python
# 第1層: ATRベースのストップロス（通常）
stop_loss_price = entry_price - (ATR_14 * 2.0)

# 第2層: 絶対値ストップ（ATRが異常に大きい場合の安全弁）
absolute_stop = entry_price * 0.95  # -5%

# 実効ストップロス = max(第1層, 第2層)  # 損失が小さい方を採用

# 第3層: ポートフォリオレベル
# 日次損失4%で回路ブレーカーLevel 1発動（セクション5参照）
```

### [v3新規追加] limit付きstop orderの実装

```python
# ストップ価格とリミット価格の乖離幅設定
def calculate_stop_limit_prices(entry_price: float, atr: float) -> dict:
    stop_price = entry_price - (atr * 2.0)       # 通常のストップ価格
    limit_offset = atr * 1.0                       # リミット価格の乖離幅 = ATR x 1.0
    limit_price = stop_price - limit_offset        # リミット価格

    # 安全弁: リミット価格がエントリー価格の-8%を下回らない
    absolute_floor = entry_price * 0.92
    limit_price = max(limit_price, absolute_floor)

    return {
        "stop_price": round(stop_price, 2),
        "limit_price": round(limit_price, 2),
    }

# 未約定時のフォールバック:
#   midday/eod実行時に以下を判断:
#   (a) 株価がリミット価格以下で推移中 → 成行注文で即クローズ（損切り確定）
#   (b) 株価がストップ価格-リミット価格の間 → 新しいlimit付きstop orderを再設定
#   (c) 株価がストップ価格以上に回復 → 元のストップロスを維持
```

### ポジションサイズ計算

[v3変更] イベント種別ごとのスリッページ係数を導入。

```python
# 改善版: イベント種別ごとのスリッページ係数
SLIPPAGE_COEFFICIENTS = {
    "earnings_normal": 1.5,      # 通常の決算発表
    "earnings_surprise": 2.0,    # EPS miss + ガイダンス引下げ
    "fomc_cpi": 1.2,             # マクロイベント
    "geopolitical": 3.0,         # 地政学イベント（テールイベント）
    "normal": 1.1,               # 通常日
}

def calculate_position_size(entry_price, stop_loss_price, total_capital,
                            event_type="normal"):
    slippage_factor = SLIPPAGE_COEFFICIENTS.get(event_type, 1.3)
    risk_per_share = entry_price - stop_loss_price
    adjusted_risk_per_share = risk_per_share * slippage_factor
    max_risk = total_capital * 0.010  # 総資金の1.0%
    position_size = int(max_risk / adjusted_risk_per_share)

    # ポジションサイズ上限キャップ
    max_position_value = total_capital * 0.20  # 総資金の20%
    position_size = min(position_size, int(max_position_value / entry_price))
    return position_size
```

### イベント種別ごとの保有期間テーブル

| イベント | 推奨保有期間 | タイムストップ | 根拠 |
|----------|-------------|--------------|------|
| 決算サプライズ（ポジティブ+初日下落） | 3-5日 | 5日 | PEAD研究: 5日以内に60-70%のドリフトが発生 |
| 決算サプライズ（ポジティブ+初日上昇） | 1-3日 | 3日 | 初期モメンタムの継続は短い |
| マクロイベント（FOMC、CPI） | 1-2日 | 2日 | 市場の消化速度が速い |
| セクターローテーション | 5-10日 | 10日 | ファンドのリバランスに数日を要する |

**時間減衰ストップ**: 保有5日経過後に含み益がATR x 1.0未満ならクローズ（「動かないポジション」の機会コスト削減）。

### パラメータ完全リスト（明示的5個 + 暗黙的7個 = 計12個）

全パラメータを文書化し、変更管理の対象とする。

**明示的パラメータ（5個）**

| # | パラメータ | 値 | 根拠 |
|---|-----------|-----|------|
| 1 | LLMセンチメント確信度閾値 | 70% | Phase 0の精度検証結果に基づき調整 |
| 2 | MA期間（フィルター） | 50日 | 中期トレンドの標準的な期間 |
| 3 | ストップロス距離 | ATR×2.0 | ノイズに引っかからない距離 |
| 4 | テイクプロフィット | ATR×3.0 | ATR連動。リスクリワード比1:1.5 |
| 5 | タイムストップ | イベント別 | イベント種別ごとに設定 |

**暗黙的パラメータ（7個）**

| # | パラメータ | 値 | 根拠 |
|---|-----------|-----|------|
| 6 | RSI期間 | 14日 | 標準的な設定 |
| 7 | RSI上限 | 70 | 過熱排除 |
| 8 | 出来高比較期間 | 20日 | 標準的な設定 |
| 9 | マクロレジーム VIX閾値 | 18/25 | 調整済み |
| 10 | マクロレジーム MA期間 | 200日 | 長期トレンドの標準 |
| 11 | ATR期間 | 14日 | 標準的な設定 |
| 12 | 最小保有期間 | 2日 | チャーン防止 |

### [v3変更] LLMセンチメント確信度のキャリブレーション

```
キャリブレーション運用タイムライン:
| 時期 | データ件数 | アクション |
|------|----------|-----------|
| Phase 0 | 200件 | パイロットキャリブレーション構築。Platt Scaling |
| Phase 5 Month 1 | +30-60件 | キャリブレーションなしで運用。データ蓄積のみ |
| Phase 5 Month 2 | +30-60件 | 初回キャリブレーション更新。ECE < 0.10 目標 |
| Phase 5 Month 3+ | +30-60件/月 | 月次再キャリブレーション。ECE < 0.05 目標 |
| 累計100件到達 | 100件+ | Isotonic Regressionへの切替を検討 |

実装:
- n < 100: Platt Scaling（パラメータ2つで安定、LogisticRegression）
- n >= 100: Isotonic Regression（柔軟だがデータ量が必要）
- 最小サンプルサイズ: Platt Scaling 50件、Isotonic 100件
- 確信度とリターンの相関分析を月次で実施
- Expected Calibration Error (ECE) < 0.05 を目標
```

---

## 5. 目標リターンとリスク許容度

### [v3変更] リターン目標（段階的設定 + 取引コスト込み）

| フェーズ | 期間 | ネットリターン目標 | シャープレシオ | 意味 |
|----------|------|-----------------|---------------|------|
| Phase 1 (検証) | 1-3ヶ月 | SPYに-5%以内で追随 | > 0.3 | 「壊滅的損失を出さない」 |
| Phase 2 (改善) | 4-6ヶ月 | SPY並み | > 0.5 | 「市場並み+低ドローダウン」 |
| Phase 3 (成熟) | 7-12ヶ月 | SPY+5% | > 0.8 | 「安定的α創出」 |
| リアル移行 | 12ヶ月+ | [v3変更] 年率ネット6-10% | > 0.8 | 「十分な実績」 |

[v3変更] **目標の明確化**:
- 全てのリターン目標は**取引コスト込みネットリターン**で設定
- 取引コスト見込み: 年率1.5-2.5%
- 年率グロスリターン必要値: 7.5-12.5%
- リアル移行基準をSR>0.8に統一（v2のplanning-logとの不整合を修正）
- [v3追加] 目標リターンは「事前に固定する」のではなく、**Phase 0結果に基づいて事後的に校正**する

[v3変更] **段階的目標のサンクコスト罠への警告**:
> 各Phaseの「合格」は「撤退しない条件」であり「成功の証明」ではない。Phase 1でSR>0.3だからといって、プロジェクトの成功を意味しない。常に「SPYバイ&ホールドのSR（0.4-0.5）を下回っていないか」をチェックすること。

### ベンチマーク比較（多層化）

| ベンチマーク | 目的 |
|-------------|------|
| SPY (S&P500 ETF) | 市場全体との比較 |
| RSP (Equal Weight S&P500) | 大型株バイアスの除去 |
| 60/40ポートフォリオ | リスク調整後のフェアな比較 |
| ランダムエントリー+同一リスク管理 | LLMセンチメントの付加価値を純粋に測定 |

### リスク許容度

1トレードリスクを1.0%に引き下げ、VIX連動のポジション数制限を適用。

| 指標 | 制限値 | 根拠 |
|------|--------|------|
| 1トレードの最大リスク | 総資金の1.0% | ギャップダウン+スリッページ対策 |
| 1ポジションの最大価値 | 総資金の20% | 低ボラ銘柄の過大ポジション防止 |
| 1日の最大損失 | 総資金の4% | 回路ブレーカーLevel 1 |
| 最大同時ポジション | VIX連動（下記参照） | テールリスク対策 |
| 最大ドローダウン | 15% | 回路ブレーカーLevel 4（無期限停止） |
| レバレッジ | 1.0倍（なし） | 初期段階はレバレッジ禁止 |

### [v3変更] VIX連動のポジション数制限（拡張版）

[v3変更] 絶対値VIXに加え、相対VIXとVIXスパイク条件を導入。

**基本ルール（絶対値VIX）**:

| VIX水準 | 最大同時ポジション |
|---------|-------------------|
| VIX < 20 | 5 |
| VIX 20-30 | 3 |
| VIX > 30 | 新規エントリー禁止 |

**[v3新規追加] 相対VIXルール**:

```python
def get_vix_regime(current_vix: float, vix_ma_60d: float) -> str:
    """VIXの相対位置でレジーム判定"""
    vix_ratio = current_vix / vix_ma_60d

    if vix_ratio < 1.0 and current_vix < 25:
        return "low"       # 5ポジション
    elif vix_ratio < 1.5 or current_vix < 30:
        return "elevated"  # 3ポジション
    else:
        return "extreme"   # 新規エントリー禁止

    # 絶対値のフロアも維持（VIX > 35は問答無用で新規禁止）
```

**[v3新規追加] VIXスパイク条件**:

```
VIX日次変化率 > +50%: 即座に新規エントリー禁止（1営業日）
VIX日次変化率 > +30%: ポジション数を3に制限（1営業日）
上記の解除: 翌営業日に再判定
```

**[v3新規追加] VIX/VIX3Mレシオ**:

```
VIX/VIX3M > 1.0（バックワーデーション = ストレス先行指標）:
  - ポジションサイズを通常の75%に縮小
  - 新規エントリーの確信度閾値を80%に引き上げ（通常70%）
```

### 回路ブレーカー

| Level | 条件 | アクション |
|-------|------|-----------|
| 1 | 日次損失 > 4% | 新規エントリー停止。翌日再開 |
| 2 | 日次損失 > 7% | 全ポジションクローズ。3営業日50%縮小で運用 |
| 3 | 月次損失 > 10% | 全ポジションクローズ。1週間停止。戦略レビュー |
| 4 | 総ドローダウン > 15% | 全ポジションクローズ。無期限停止。根本的見直し |

**クーリングオフ期間**: Level 1発動後、次のLevel 1リセットまで48時間（2営業日）。連日のLevel 1発動は即Level 2へエスカレーション。

**ドローダウン計算**: High Water Mark基準（ピークからの最大下落率）とする。

### [v3変更] リアル移行時の回路ブレーカー段階的厳格化

```
旧（v2）: 一気に50%引き下げ
新（v3）: リアル移行Stageに応じた段階的厳格化

| Stage     | Level 1 | Level 2 | Level 3 | Level 4 | 根拠                      |
|-----------|---------|---------|---------|---------|---------------------------|
| ペーパー  | 4%      | 7%      | 10%     | 15%     | 現行                      |
| Stage 1   | 3%      | 5%      | 7.5%    | 12%     | 75%に引き下げ             |
| Stage 2   | 2.5%    | 4.5%    | 6%      | 10%     | 62.5%に引き下げ           |
| Stage 3-4 | 2%      | 3.5%    | 5%      | 10%     | 50%に引き下げ（最終形）   |

事前シミュレーション義務★v3新規★:
  ペーパートレーディング6ヶ月分の日次PnLデータに対して厳格化閾値を
  遡及適用し、発動頻度をカウントする。
  目標: Level 1の発動が月2回以下、Level 2は四半期1回以下。
```

### 段階的撤退の導入

| ドローダウン | アクション |
|-------------|-----------|
| 10% | ポジション数を3に制限 + ポジションサイズ50%縮小 |
| 12% | ポジション数を1に制限 + 1週間の冷却期間 |
| 15% | 無期限停止 |

### [v3新規追加] 段階的撤退の自動化アルゴリズム

```python
def select_positions_to_close(positions: list, target_count: int) -> list:
    """縮小対象のポジションを機械的に選定。
    人間の判断もLLMの判断も排除し、定量的なルールで決定する。"""
    if len(positions) <= target_count:
        return []

    n_to_close = len(positions) - target_count

    for pos in positions:
        pos.close_score = 0
        # (1) 保有期間がタイムストップに近い → クローズ優先
        if days_held > pos.time_stop_days * 0.8:
            pos.close_score += 3
        # (2) 含み損が大きい（ストップロスに近い） → クローズ優先
        if loss_pct < -0.03:
            pos.close_score += 2
        # (3) セクター重複がある → 重複セクターから優先
        if sector_count > 1:
            pos.close_score += 1
        # (4) 直近のLLMセンチメントがネガティブに転換 → クローズ優先
        if pos.latest_sentiment == "negative":
            pos.close_score += 2

    # スコア降順でソートし、上位n_to_close件をクローズ対象
    positions_sorted = sorted(positions, key=lambda p: p.close_score, reverse=True)
    return positions_sorted[:n_to_close]
```

### [v3変更] 撤退基準

以下のいずれかに該当した場合、プロジェクトを停止し根本的な見直しを行う:
- 12ヶ月経過時点でシャープレシオ < 0.5
- 6ヶ月連続でSPYのバイ&ホールドに劣後
- LLMセンチメント判定精度がPhase 0基準（65%）を下回る
- 累計ドローダウンが15%を超過

[v3新規追加] **各Phaseの明示的No-Go基準**:

| フェーズ | No-Go基準（いずれかで即時撤退検討） |
|----------|----------------------------------|
| Phase 1 | SR < 0。3ヶ月で勝率 < 45% |
| Phase 2 | SR < 0.3。6ヶ月累計でSPYに-10%以上劣後 |
| Phase 3 | SR < 0.5。alpha decayでLLM精度 < 60% |

### [v3新規追加] 撤退判断のシステム化

```
撤退バイアスへの対抗策:
1. 撤退基準に抵触した場合、trading_agent.pyが自動的に新規エントリーを停止
2. Slackに「撤退基準に抵触。手動で再開するには config.toml の
   force_resume = true を設定してください」と通知
3. 再開のハードルを意図的に上げることで、サンクコストバイアスに対抗
4. 累積APIコスト$300の「中間撤退レビュー」を追加
   $300時点で残りの$200で何が検証できるかを強制レビュー
```

**月次チェックポイント**: 毎月の中間評価を義務化。月次で混同行列とキャリブレーションプロットをレビュー。

---

## 6. 相関リスク管理

### [v3変更] セクター間相関マトリクス（動的管理へ移行）

「同一セクター最大2銘柄」のルールだけでは不十分。セクター間の相関を考慮する。

| 相関レベル | ペア例 | 扱い |
|-----------|--------|------|
| 高相関 (> 0.7) | XLK-XLC, XLY-XLC | 合算して同一セクター扱い |
| 中相関 (0.3-0.7) | XLF-XLY | 通常の分散効果 |
| 低相関 (< 0.3) | XLE-XLK, XLV-XLF | 高い分散効果 |

### 実効分散度の計算

```python
# 実効分散度 = ポジション数 x (1 - 平均ペア相関)
# 最低 2.0 以上を維持
effective_diversification = n_positions * (1 - avg_pairwise_correlation)
if effective_diversification < 2.0:
    alert("Insufficient diversification")
```

### [v3新規追加] EWMA相関（日次更新）

```python
def calculate_ewma_correlation(returns_matrix, lambda_=0.94):
    """EWMA（指数加重移動平均）相関 -- 直近のデータに重みを置く
    RiskMetrics方式: 危機時の相関変化を素早く捕捉"""
    n = returns_matrix.shape[0]
    weights = np.array([(1 - lambda_) * lambda_**i for i in range(n-1, -1, -1)])
    weights /= weights.sum()
    weighted_returns = returns_matrix * weights[:, np.newaxis]
    return np.corrcoef(weighted_returns.T)
```

### [v3新規追加] 相関ブレイクアウト警告

```
相関ブレイクアウト条件:
  - 20日ローリング相関の平均 + 2σ を超えた場合
  - 対応: 該当ペアの合計エクスポージャーを50%に制限
  - VIX > 25 かつ 相関ブレイクアウト: 全ポジション数を3以下に強制縮小
```

### [v3新規追加] 相関レジーム分類

| 相関レジーム | 判定条件 | 最大ポジション | 実効分散度要件 |
|-------------|---------|-------------|-------------|
| 低相関（平常） | 平均ペア相関 < 0.5 かつ VIX < 25 | 5 | >= 2.0 |
| 高相関（警戒） | 平均ペア相関 >= 0.5 または VIX 25-30 | 3 | >= 1.5 |
| 超高相関（危機） | 平均ペア相関 >= 0.7 または VIX > 30 | 1-2 | 制限なし |

### 危機時の相関リスク

- 危機時には全銘柄の相関が1.0に収束する（"correlations go to 1 in a crisis"）
- VIX > 30 で相関リスク警告を出し、ポジション数を制限（VIX連動制限と連動）
- 共通リスクファクター（金利感応度、ドル感応度、原油感応度）へのエクスポージャーを月次で監視

---

## 7. 統計的有意性基準

### 検証期間とサンプルサイズ

| 項目 | 旧基準 | 現基準 | 変更理由 |
|------|--------|--------|----------|
| 最低運用期間 | 3ヶ月 | 12ヶ月 | 3ヶ月では全マーケットレジームを経験できない |
| 最低取引回数 | 100回 | 300回 | 勝率55%を検出するには約385取引が理想。300回は現実的な妥協点 |
| 評価手法 | 絶対リターン | ベンチマーク対比α | 市場環境の影響を排除 |

[v3追加] **12ヶ月の限界の認識**: 12ヶ月は「必要だが十分ではない」。市場レジームは非定常過程であり、12ヶ月で経験できるレジームは高々2-3種類。12ヶ月後のリアル移行は「確信」ではなく「暫定的判断」であることを明記。

[v3追加] **レジーム未経験時ルール**: 12ヶ月間でブル/ベア/レンジの3レジームのうち1つでも未経験なら、リアル移行を延期。

### [v3変更] ベイズ的アプローチ（事前分布感度分析付き）

少ないサンプルでも段階的に意思決定するため、ベイズ的アプローチを併用する。

```
事前分布: SR ~ Normal(0, 0.5)（スキルなしが事前の期待）
事後分布: 取引結果で更新
リアル移行条件: 事後確率 P(SR > 0.5 | data) > 90%
```

**[v3新規追加] 事前分布感度分析の必須化**:

```
以下の4つの事前分布で事後確率を比較し、
全てでP(SR > 0.5) > 80% を満たした場合にのみリアル移行を許可:

  1. 懐疑的事前:    Normal(0, 0.3)   -- 強くスキルなしを信じる
  2. 中立的事前:    Normal(0, 0.5)   -- 基本の事前
  3. 楽観的事前:    Normal(0.2, 0.7) -- やや楽観的
  4. コスト調整事前: Normal(-0.3, 0.5) -- 取引コスト考慮（スキルなしならSRはマイナス）

判断基準:
  - 4つの事前全てで P(SR>0.5|data) > 80%: 「事前に頑健」→ リアル移行可
  - 事前によって50%以上の差がある場合: 「データ不足」→ 判断延期
  - 事前分布の選択根拠はPhase 0終了時に確定。以降変更禁止

ベイズ + フリークエンシスト併用★v3新規★:
  - ベイズ的アプローチを「唯一の判断基準」にせず、
    ブートストラップ信頼区間と併用
  - 両方の基準を満たすことを要求
```

### [v3変更] BayesianSharpeEstimator実装骨格

```python
class BayesianSharpeEstimator:
    """共役事前分布（正規-正規モデル）。MCMCは不要。"""

    def __init__(self, prior_sr_mean=0.0, prior_sr_std=0.5):
        self.typical_sigma = 0.015  # 日次リターンの典型的標準偏差
        # SRからmu（日次平均リターン）に変換
        self.prior_mu_mean = prior_sr_mean * self.typical_sigma / np.sqrt(252)
        self.prior_mu_var = (prior_sr_std * self.typical_sigma / np.sqrt(252)) ** 2

    def update(self, daily_returns):
        """共役事前分布の更新公式で事後分布を計算"""
        # posterior_mu = (prior_mu/prior_var + n*sample_mean/sample_var)
        #               / (1/prior_var + n/sample_var)
        # → P(SR > 0.5 | data) を算出

    def sensitivity_analysis(self, daily_returns):
        """4つの事前分布で結果がどう変わるかを報告"""
        # 結果が事前分布に大きく依存 → データ不足。判断延期
        # 結果が事前分布にほぼ依存しない → データ十分。判断可能
```

### [v3変更] 多重比較の補正（BH法への移行）

[v3変更] Bonferroni補正は保守的すぎてType IIエラー（見逃し）を増大させる。Benjamini-Hochberg (BH) 法に移行。

```
BH法（FDR制御）:
  a. K回のパラメータ変更のp値を小さい順にソート: p_(1) <= ... <= p_(K)
  b. 各p値に対して閾値を計算: threshold_(i) = (i/K) * alpha
  c. p_(i) <= threshold_(i) を満たす最大のiを求める
  d. p_(1), ..., p_(i) に対応する改善を「有効」と判断

  FDR水準: alpha = 0.10（改善のうち10%までは偽陽性を許容）

追加条件:
  - 各パラメータ変更は最低20取引のクールダウン後に評価
  - 評価はout-of-sample（変更後の新しいデータのみ）で行う
  - 同一パラメータの「戻し」は新たな変更としてカウントしない

実装: statsmodels.stats.multitest.multipletests(pvalues, method='fdr_bh')
```

### [v3変更] 探索的分析と確証的分析の分離

```
- 探索的（仮説生成）: パフォーマンスダッシュボードの自由な分析。
  p値なし。「こういう傾向がありそうだ」の段階
- 確証的（仮説検定）: 具体的なパラメータ変更→効果測定。
  BH法でFDR制御。「この変更は有効である」の判断

混同が危険な例:
  「ダッシュボードで確信度80%以上の取引が好成績→
   閾値を80%に引き上げよう→引き上げたら好成績→有意!」
  → 同じデータで仮説を生成し検定した（p-hacking）のであり無効。
  変更後の新しいデータのみで検証しなければならない。
```

### [v3新規追加] PurgedTimeSeriesSplit（金融時系列CV）

```python
class PurgedTimeSeriesSplit:
    """Lopez de Prado (2018) のPurged Cross-Validationの簡略版

    |<-- train -->|<purge>|<-- test -->|<embargo>|

    パラメータ:
    - n_splits: 5（推奨）
    - train_period_days: 252（1年）
    - test_period_days: 63（3ヶ月）
    - purge_days: 10（最大保有期間に一致。リーケージ防止）
    - embargo_days: 5
    """
```

### ブートストラップ法の実装

```
取引結果のリサンプリング（復元抽出）を10,000回
シャープレシオの95%信頼区間を算出
信頼区間の下限が0を超えていれば有意
```

---

## 8. セクターETF補完戦略

「セクターモメンタム戦略」として明確化。

### エントリー条件

```
1. 20日リターンでセクターETFをランキング
2. 上位2セクターのETFをロング候補
3. LLMでマクロ環境（FOMC議事録、経済指標、セクター別ニュース）を分析
4. LLMが「ポジティブ」判定 + 20日モメンタム上位 → エントリー
5. [v3変更] ポジションサイズ: リスク等価方式（下記参照）
```

### エグジット条件

```
1. 20日リターンランキングで下位3に転落 → クローズ
2. ストップロス: ATR x 2.5（ETFはATRが小さいため係数を広く）
3. 保有期間上限: 15営業日（個別株より長い）
```

### [v3変更] リスク等価ポジションサイジング

```
旧: ETFポジションサイズ = 個別株の50%（固定比率）
新: リスク等価方式

各ポジションのリスク金額を総資金の1.0%で統一する。
ETF_position_risk = ETF_qty * ETF_ATR * ETF_SL_multiplier
Stock_position_risk = Stock_qty * Stock_ATR * Stock_SL_multiplier

ETFのATRが個別株の約40-60%であることを考慮すると、
ETFのポジションサイズは自然に個別株の1.5-2.5倍になる。
→ 「50%」ではなく、リスクベースで自動計算
```

### [v3変更] 個別株との共存ルール（柔軟化）

| 期間 | 個別株上限 | ETF上限 | 条件 |
|------|-----------|--------|------|
| [v3変更] 決算シーズン中 | 5 | 1 | ETFはメイン銘柄と異なるセクターのみ |
| 決算シーズン外 | 2 | [v3変更] 3 | セクター重複なし条件 |
| [v3追加] マクロイベント週 | 2 | 2 | FOMC/CPI/雇用統計週 |

総エクスポージャー上限: 常に80%を維持。

### [v3新規追加] セクター重複排除ルール

```
- ETFポジションと同一セクターの個別株ポジションは合計で
  セクター配分上限（例: テクノロジー30%）を超えないこと
- XLKをロングしている場合、テクノロジー個別株は最大1銘柄
- ETF-個別株間の相関を月次で計算し、相関0.7以上のペアは
  同一セクター扱い
```

### ETF候補

| ETF | セクター | LLM分析との相性 |
|-----|---------|----------------|
| XLK | テクノロジー | 決算分析 |
| XLV | ヘルスケア | FDA承認、規制ニュース |
| XLF | 金融 | 金利政策分析 |
| XLE | エネルギー | OPEC、地政学分析 |
| XLI | 資本財 | ISM製造業指数との連動 |
| XLU | 公益事業 | 金利感応度が高く、FOMC分析と相性良い |
| XLRE | 不動産 | 金利サイクルとの逆相関、分散効果 |

**禁止**: レバレッジETF（TQQQ, SOXL等）は絶対禁止。

### 決算期間外の戦略オプション

| オプション | 内容 | 適用条件 |
|-----------|------|----------|
| Option A（推奨） | ETFモメンタム戦略 + マクロイベント限定の個別株 | 通常時 |
| Option B（保守的） | 現金100%で待機 | ベアレジーム時 |

---

## 9. Kelly基準との整合性

### [v3変更] 期待値の検証（取引コスト込み）

```
仮定: 勝率55%, 平均利益/平均損失 = 1.5 (TP: ATR×3.0 / SL: ATR×2.0)
Kelly% = (0.55 × 1.5 - 0.45) / 1.5 = 25%
Half Kelly = 12.5%

現在のリスク設定: 1.0%（Kelly比 4%、極めて保守的）

年間期待リターンの試算（取引コスト込み）★v3変更★:
  グロスリターン: 1.0% × 年間約80トレード × 平均純利益率
  取引コスト: 年率1.5-2.5%
  APIコスト: $240/年（$10,000資金なら2.4%）
  ネットリターン = グロス - 取引コスト - APIコスト按分

  → 年率ネット6-10%を達成するには:
    a. 勝率60% + RR比2.0 + 年間80取引（最低ライン）
    b. 勝率65% + RR比1.5 + 年間80取引
    c. 勝率60% + RR比2.0 + 年間120取引
```

### [v3変更] 目標リターンとの整合性

- 目標リターンは「事前に決める」のではなく、Phase 0の結果から導出する
- Phase 0で得られた実績勝率とRR比からKelly%を再計算し、リスク上限を動的に調整
- Phase 0の結果がシナリオ(a)-(c)のいずれにも該当しない場合、目標リターンを年率3-5%に再引き下げ
- [v3追加] テイクプロフィットの再検討: ATR x 3.0（RR比1.5）で不足の場合、Phase 1でATR x 4.0（RR比2.0）のA/Bテストを実施（「1変数ずつ」ルールに従い、最初の2ヶ月はATR x 3.0で運用し、3ヶ月目に変更して比較）

### 破産確率

- 保守的な仮定（勝率50%、RR比1:1.5）での破産確率を計算し、1%未満であることを確認
- 15%ドローダウンを「破産」と定義

---

## 10. シグナル枯渇問題への対応 [v3新規セクション]

### 問題の背景

年間の決算シーズンは4回（各3-4週間）、ピーク期間は年間12-16週間。残りの36-40週間（約7-8ヶ月）は「シグナル枯渇期間」。決算ドリブンのエッジに年の1/3しか使えないなら、年率8-12%の目標達成には非現実的なリターン率が必要。

### 3段階アプローチ

**第1段階: 決算シーズンの「ロングテール」活用（即時実装可能）**

```
- S&P500の500銘柄の決算は約6週間にわたって分散
- ユニバース50-80銘柄なら、ピーク前後2-3週間にも月5-10件のシグナル発生
- シーズン間の「完全な空白」は実質2-3ヶ月に縮小
```

**第2段階: マクロイベントドリブンの追加（Phase 2以降）**

```
対象イベント: FOMC（年8回）、CPI（毎月）、雇用統計（毎月）、
  ISM製造業/非製造業（毎月）
シグナル生成:
  1. イベント前: LLMでマクロ環境を分析、セクター影響を予測
  2. イベント後30分: 市場反応とLLM予測の乖離を検出
  3. 乖離あり → セクターETFでエントリー
注意: Phase 0で別途検証（20イベント x $0.03 = $0.60）
```

**第3段階:「ガイダンス更新」「アナリストレーティング変更」シグナル**

```
- Alpaca News APIで以下をキーワード監視:
  a. "guidance update", "revised outlook", "pre-announcement"
  b. "upgrade", "downgrade", "initiating coverage"
  c. "FDA approval", "contract win", "patent ruling"
- 決算ドリブンと同じ仮説の延長線:
  「LLMがポジティブ判定 + 市場の初期反応がネガティブ → リバウンド」
- 追加シグナル見込み: 月3-5件
```

### 推定年間シグナル分布（改善後）

| 期間 | シグナル/月 | 月数 | 年間合計 |
|------|----------|-----|---------|
| 決算ピーク（4回） | 12-15 | 4 | 48-60 |
| 決算周辺 | 5-8 | 4 | 20-32 |
| シーズン外（マクロ+ニュース） | 3-6 | 4 | 12-24 |
| 合計 | | 12 | 80-116 |

---

## 11. Alpha Decayモニタリングフレームワーク [v3新規セクション]

> **これは「もし」ではなく「いつ」の問題**。LLMセンチメントのエッジは時間とともに確実に消失する。

### Alpha Decayを駆動するメカニズム

1. **参加者増加**: GPT/Claude/Geminiでセンチメント分析する個人・機関が指数関数的に増加
2. **LLMの一般化**: 同じプロンプトで同一方向のポジションが集中し、エッジが消失
3. **市場の適応**: LLMセンチメントが一方向に傾くパターンをHFTが学習し、先回り
4. **PEADの縮小トレンド**: McLean & Pontiff (2016) -- 学術論文発表後にアノマリーの平均リターンが58%縮小

### 月次精度トラッキング

```
1. LLMセンチメント精度を月次で測定（混同行列 + 方向性精度）
2. 精度の3ヶ月移動平均を計算
3. 移動平均が2ヶ月連続で低下 → Alpha Decay Warning
4. 移動平均がPhase 0基準（65%）に到達 → Alpha Decay Critical
```

### Edge Half-Life（エッジ半減期）の推定

```
- Phase 0精度をP0、月次精度をPtとする
- ベースライン精度（ランダム = 33.3%、ナイーブ = 推定50%）をPbaseとする
- エッジ = Pt - Pbase
- エッジ半減期 = 月数t where (Pt - Pbase) = (P0 - Pbase) / 2
- 6ヶ月分のデータが蓄積されたら回帰分析で半減期を推定
- 半減期 < 12ヶ月の場合: 戦略の根本的再設計が必要
```

### 「エッジ枯渇」時のプランC

```
シナリオ: LLM精度が55-60%に低下（エッジは残存するが薄い）
対応:
  a. LLMの役割を「エントリーシグナル」から「リスクフィルター」に切替
     - テクニカル/モメンタムでエントリー候補を選定
     - LLMは「この銘柄にネガティブリスクがないか」のスクリーニングに使用
     - エッジの源泉をLLMからテクニカルに移転

  b. プロンプトの差別化を追求
     - 汎用的な「センチメント判定」ではなく、
       「アナリストコンセンサスとの乖離度」
       「一時的要因vs構造的要因の判別」
       など、LLMの文脈理解力が真に発揮される特化型プロンプトに進化
     - コモディティ化された「ポジティブ/ネガティブ」判定から脱却

  c. マルチモデルアンサンブル（コスト増加分を考慮）
     - Claude + GPT-4 + Gemini の3モデルで同一判定
     - 3モデル一致 = 高確信、2:1 = 中確信、バラバラ = 見送り
```

---

## 12. ストレステスト [v3新規セクション]

> v2のストレステストは「仮定ベースの概算」だった。v3では実際のヒストリカルイベントに基づく再現テストを実施する。

### ヒストリカルシナリオ

**シナリオ1: 2020年3月 COVID-19パンデミックショック**

```
期間: 2020年2月19日（S&P500ピーク）〜 2020年3月23日（ボトム）
S&P500: -33.9%、VIX: 14→82
想定ポジション: AAPL, MSFT, JPM, JNJ, XOM（5セクター分散）
検証項目:
  - 各銘柄の日次リターンで回路ブレーカー発動タイミング
  - ストップロスのスリッページ推定
  - limit付きstop orderが機能したかの検証
  - 最終的な推定損失額
```

**シナリオ2: 2022年1-6月 インフレショック + 利上げサイクル**

```
期間: 2022年1月3日〜2022年6月16日
S&P500: -23.6%、VIX: 17→34
特徴: 急落ではなくジリ下げ。「茹でガエル」パターン
検証項目:
  - 月次損失が10%に達するまでの期間
  - 段階的撤退メカニズムの有効性
  - マクロレジーム4変数モデルがベアレジームを何日目に検出するか
```

**シナリオ3: 2023年3月 SVB（シリコンバレー銀行）危機**

```
期間: 2023年3月8日〜2023年3月15日（1週間）
特徴: セクター固有のショック（金融）が他セクターに波及
検証項目:
  - セクター集中リスクの実証
  - 相関リスクの波及パターン
  - 静的相関 vs 動的EWMA相関の差異
```

**シナリオ4: 2024年8月5日 日銀利上げ+円キャリーアンワインド**

```
期間: 2024年8月1日〜2024年8月8日
S&P500: -6.1%（8月5日単日で-3.0%）、VIX: 16→65（1日で4.1倍）
検証項目:
  - 回路ブレーカーLevel 1発動タイミング
  - V字回復時の機会損失
  - VIXスパイク条件の発動速度
```

**シナリオ5: 2010年5月6日 フラッシュクラッシュ**

```
期間: 2010年5月6日 14:42-14:52（10分間）
S&P500: 日中-9.2%（終値ベース-3.2%）
検証項目:
  - limit付きstop orderの機能検証
  - limit価格の設定幅の妥当性
```

### [v3新規追加] ギャップリスクの確率分布モデル

```
Phase 0のバックテストデータ4,000件から算出:
  - 決算発表後の翌営業日始値 vs 前日終値のギャップ幅
  - ギャップ幅の中央値、平均、標準偏差、90/95/99パーセンタイル
  - ATR対比のギャップ倍率（ギャップ幅 / ATR(14)）の分布
  - 分布フィッティング（正規分布、t分布、一般化パレート分布）

イベント種別ごとのスリッページ係数:
  | イベント種別          | 推定スリッページ係数 | 根拠                       |
  |-----------------------|---------------------|---------------------------|
  | 決算発表（通常）      | 1.5-2.0             | 95%ileギャップ/ATR比       |
  | 決算発表（サプライズ）| 2.0-3.0             | EPS miss + ガイダンス引下げ |
  | FOMC/CPI              | 1.2-1.5             | マクロイベントは分散が小さい |
  | 地政学イベント        | 3.0-5.0             | テールイベント、制御不能    |
  | 通常日（決算なし）    | 1.1-1.2             | 平時のスプレッド拡大程度    |
```

### テールリスクヘッジの定量分析

```
結論: 常時ヘッジはコスト面から非現実的（年率4.8-15.6%のリターン低下）

限定的テールリスクヘッジ戦略（リアル移行Stage 3以降で検討）:
  発動条件:
    (a) VIX/VIX3M > 1.0（バックワーデーション）
    (b) リアル移行Stage 3以降（資金50%以上）
    (c) 決算集中期

  ヘッジ手段:
    - SPYプット（権利行使価格: -7%OTM、期間: 2週間）
    - コスト上限: 月間リターンの1%以内
    - VIX < 20の時に事前購入（プレミアム低減）

  年間推定ヘッジコスト: 年4-6回 x $30-50 = $120-300（年率1.2-3.0%）
```

---

## 13. 暗黙の前提リスト

本戦略が成立するために必要な前提を明示的にリスト化する。これらの前提が崩れた場合の対応策を含む。

| # | 暗黙の前提 | リスク | 対応策 |
|---|-----------|--------|--------|
| 1 | LLMのセンチメント分析が未織り込み情報を提供する | Phase 0で検証。[v3変更] 65%未満なら撤退 | Phase 0の厳格実施 |
| 2 | Claude APIの出力品質がバージョン間で一貫している | モデル更新で戦略パフォーマンスが急変 | プロンプトバージョン管理、モデル変更時の再検証 |
| 3 | Alpaca APIの仕様・価格が安定する | SDK breaking changes | 依存パッケージのバージョン固定 |
| 4 | S&P500大型株市場に非効率性が存在する | 効率的市場仮説が正しければαはゼロ | ベンチマーク対比で継続評価 |
| 5 | ペーパートレーディングの結果がリアルで再現可能 | 再現率は50-70%の可能性 | ペーパー/リアル並行運用期間の設定 |
| 6 | macOSマシンが十分な稼働率を維持できる | 年間5-7%のジョブ欠落リスク | launchd移行、将来的にクラウド移行 |
| 7 | 運用者がルール変更の衝動に耐えられる | 行動バイアスによるルール逸脱 | [v3変更] 撤退判断のシステム化（自動停止） |
| 8 | 決算オーバーリアクションが系統的に発生する | PEADのα縮小傾向 | Phase 0のバックテストで定量検証 |
| 9 | [v3追加] LLMセンチメントのalphaが12ヶ月以上持続する | alpha decay（コモディティ化） | Alpha Decayモニタリング、プランC |

---

## 14. Reconciliation安全性 [v3新規セクション]

### Alpacaを正とするルールの改善

```
v2: 「Alpaca API = Source of Truth」で無条件に自動修正
v3: 差異の規模に応じた段階的対応

1. 差異の内容をログに記録（全ケース）
2. 閾値判定:
   - ポジション数不一致が3以上 → 自動修正を停止、アラートのみ
   - 存在しないはずのポジションが3つ以上Alpacaにある → 同上
   - 上記以外 → 従来通り自動修正

3. レースコンディション対策:
   - get_all_positions() を2回連続で呼び出し、結果が一致した場合のみ
     Reconciliationを実行

4. ソース管理:
   - DBに source カラム（'agent' / 'reconciliation' / 'manual'）を追加
   - reconciliation由来のポジションには自動的にストップロスを設定
```

---

## 15. 実装の段階的スコープ（MVP方針） [v3新規セクション]

> **DEVILの指摘**: v2の全機能を1人で実装・運用するのは非現実的。MVP思想を導入。

### Phase 1 必須（最小限で動くシステム）

| 機能 | 実装工数 | 根拠 |
|------|---------|------|
| Phase 0検証パイプライン | 20h | Go/No-Go判断に必須 |
| 2変数マクロモデル（200日MA + VIX） | 4h | 最低限のレジーム判定 |
| 同一セクター2銘柄制限 | 2h | 簡易的な分散ルール |
| ブートストラップ法（SR信頼区間） | 4h | 統計的判断の最低限 |
| 多層ストップロス + limit付きstop | 8h | リスク管理の根幹 |
| 回路ブレーカー + 段階的撤退 | 8h | 防御の根幹 |
| 基本的なReconciliation | 8h | 状態整合性 |

### Phase 3 追加（運用データに基づいて判断）

| 機能 | 条件 | 根拠 |
|------|------|------|
| 4変数マクロモデル拡張 | 2変数で判定精度が不十分な場合 | データドリブン |
| EWMA相関 + 相関ブレイクアウト | 月次相関更新で危機検出が遅い場合 | 実績に基づく判断 |
| ベイズ事後分布更新 | ブートストラップの信頼区間が広すぎる場合 | 必要性を確認後 |
| Plattキャリブレーション | キャリブレーションプロットで大きな乖離がある場合 | データ蓄積後 |

### リアル移行時追加

| 機能 | 条件 |
|------|------|
| 段階的回路ブレーカー厳格化 | リアル移行Stage 1開始時 |
| テールリスクヘッジ | Stage 3以降、コスト分析完了後 |
| WebSocket監視 | VPS移行後 |

### 「やらないことリスト」

- DCC-GARCHモデル（Phase 4以降にデータが十分ある場合のみ検討）
- リアルタイム相関の完全な動的モデル（EWMA相関で代替）
- オプション戦略（Alpaca APIのサポート確認後）
- マルチモデルアンサンブル（alpha decay顕在化後のプランC）

---

## 変更履歴

| バージョン | 日付 | 変更概要 |
|-----------|------|---------|
| v1 | 2026-02-11 | 初版作成 |
| v2 | 2026-02-11 | 5名のAIエージェント（STRAT, QUANT, RISK, ARCH, DEVIL）v1レビュー反映 |
| v3 | 2026-02-11 | 5名のAIエージェントv3レビュー反映。実行精度・持続可能性・複雑性管理の強化 |

### v2 主要変更点サマリー

1. **Phase 0（alpha仮説の事前検証）追加**: コード実装前にLLMセンチメント精度のベースラインを確立
2. **目標リターンの修正**: 年率15%→8-12%。段階的目標設定。Kelly基準との整合性確保
3. **銘柄ユニバースの拡大**: 20-30→50-80銘柄。動的フィルター追加
4. **マクロレジーム判定の拡張**: 2変数→4変数モデル。セクターモメンタム追加
5. **エントリー条件の改善**: AND条件→階層フィルター方式。RSI矛盾の解消
6. **エグジットの改善**: テイクプロフィットATR連動化、時間減衰ストップ追加、イベント別保有期間
7. **リスク管理の強化**: 1トレードリスク1.0%、スリッページバッファ30%、多層ストップロス、VIX連動ポジション制限
8. **相関リスク管理**: セクター間相関マトリクス、実効分散度の計算
9. **回路ブレーカー修正**: Level 1(4%), Level 2(7%)に調整。段階的撤退の導入
10. **統計的有意性基準**: 検証期間12ヶ月・300取引に拡大。ベイズ的アプローチ導入
11. **パラメータ完全リスト化**: 明示的5個+暗黙的7個=計12個を文書化
12. **セクターETF補完戦略の具体化**: セクターモメンタム戦略として定義

### v3 主要変更点サマリー

**STRAT由来の改善:**

1. [v3変更] **Phase 0実行プロトコルの精緻化**: 時間バイアス検定（Step 3）追加、層化抽出法によるサンプリング、Go/No-Go判断マトリクスの詳細化、プロンプトのタイムスタンプ制約
2. [v3新規] **Alpha Decayモニタリングフレームワーク（セクション11）**: 月次精度トラッキング、エッジ半減期推定、エッジ枯渇時のプランC（LLMのリスクフィルター化、プロンプト差別化、マルチモデルアンサンブル）
3. [v3変更] **銘柄ユニバース段階的拡大の判断基準精緻化**: シグナル頻度/品質マトリクス、逆戻り条件の定義
4. [v3新規] **マクロレジームのヒステリシス**: 3営業日連続判定要件、データ遅延対処ルール
5. [v3変更] **セクターETF補完戦略の柔軟化**: 決算シーズン中もETF 1ポジション許可、リスク等価ポジションサイジング、セクター重複排除ルール
6. [v3新規] **シグナル枯渇問題への3段階アプローチ（セクション10）**: 決算ロングテール活用、マクロイベントドリブン、ガイダンス更新/アナリスト変更シグナル
7. [v3変更] **Kelly基準との整合性**: シナリオ別リターン早見表、取引コスト込みネット目標への変更

**QUANT由来の改善:**

8. [v3新規] **Phase 0バックテストコード骨格**: データパイプライン、バッチ実行、リジューム対応の具体的設計
9. [v3新規] **LLM比較実験プロトコル**: McNemar検定、Brier Score、プロンプト3種類での公正性担保
10. [v3変更] **tech_score正規化手法の明示化**: パーセンタイルランク推奨、等重みでスタート
11. [v3新規] **PurgedTimeSeriesSplit**: パージ・エンバーゴ付き時系列クロスバリデーション
12. [v3新規] **BayesianSharpeEstimator**: 共役事前分布による解析的計算、感度分析
13. [v3変更] **Platt Scaling/Isotonic Regression**: キャリブレーション実装の具体化とタイムライン
14. [v3変更] **BH法による多重比較補正**: Bonferroniから移行、FDR制御
15. [v3新規] **Mutual Information分析**: シグナル間の冗長性チェック、フィルター最適化

**RISK由来の改善:**

16. [v3新規] **ギャップリスクの確率分布モデル（セクション12）**: イベント種別ごとのスリッページ係数テーブル
17. [v3新規] **動的相関管理**: EWMA相関（日次更新）、相関ブレイクアウト警告、相関レジーム分類
18. [v3新規] **ヒストリカルストレステスト（セクション12）**: COVID-19、インフレショック、SVB危機、円キャリー巻き戻し、フラッシュクラッシュの5シナリオ
19. [v3新規] **limit付きstop order**: ATRベースの乖離幅設定、未約定時のフォールバック
20. [v3変更] **VIX閾値の拡張**: 相対VIX、VIXスパイク条件、VIX/VIX3Mレシオ
21. [v3新規] **段階的撤退の自動化アルゴリズム**: 機械的ポジション縮小スコアリング
22. [v3変更] **リアル移行回路ブレーカーの段階的厳格化**: 一気50%→Stage別段階的引き下げ
23. [v3新規] **テールリスクヘッジの定量分析**: コスト対効果を数値で提示

**DEVIL由来の改善:**

24. [v3変更] **Phase 0 Go/No-Go基準の厳格化**: 60%→65%に引き上げ、取引コスト込み期待リターンのプラス確認を追加条件に
25. [v3新規] **Alpha decayの構造的リスク認識**: 「注意書き」から「モニタリングフレームワーク」への昇格
26. [v3変更] **段階的目標のサンクコスト罠の警告**: 各Phaseに明示的No-Go基準を追加
27. [v3新規] **ベイズ事前分布感度分析の必須化**: 4つの事前分布での比較、コスト調整事前分布の追加
28. [v3新規] **Reconciliation安全性の強化（セクション14）**: 差異規模に応じた段階的対応、レースコンディション対策
29. [v3新規] **MVP思想の導入（セクション15）**: 初期スコープの大幅縮小、Phase別機能分類、「やらないことリスト」
30. [v3新規] **撤退判断のシステム化**: 自動停止メカニズム、再開ハードルの意図的引き上げ

**ARCH由来の設計改善（strategy.mdの範囲内）:**

31. [v3新規] **探索的分析と確証的分析の分離**: p-hacking防止のための制度設計
