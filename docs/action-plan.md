# アクションプラン v3

## 概要

Alpacaペーパートレーディング企画の実行計画。LLMセンチメント分析+テクニカルフィルターのハイブリッドスイングトレード戦略を実装し、ペーパートレーディングで検証する。

**v3変更サマリー**:
- **Go/No-Go閾値を65%に引き上げ**: DEVILの計算（60%精度 -> 取引コスト+APIコスト控除後 -1.4%）を反映。コスト込みネットリターンがプラスであることを確認条件に追加
- **MVPアプローチの導入**: DEVILの複雑性警告（178h開発+39h/月メンテ）を最重要視し、全タスクに「必須(MVP)」「追加」「リアル移行時」の3段階優先度を付与
- **Phase 0実行プロトコルの精緻化**: STRATの時間バイアス検定、サンプリング方法の標準化を統合
- **統計的検証の実装仕様追加**: QUANTのPurgedTimeSeriesSplit、BayesianSharpeEstimator、BH法を具体化
- **ストレステスト5シナリオの追加**: RISKの実データ再現テスト、動的相関管理を導入
- **型安全インターフェースの初期実装**: ARCHのdataclasses+Protocol、JSON Schema Validation、Phase 0検証ツールキットを追加
- **撤退基準の独立化**: 各フェーズで独立したNo-Go基準を設定し、サンクコストトラップを防止
- **工数見積もりの現実化**: MVP構成で初期開発120h、月次メンテ15h/月に抑制

---

## 1. 次にやるべきこと（優先順位付き）

全タスクに優先度を付与。**必須(MVP)** = ペーパートレーディング開始の最低条件、**追加** = 運用データで必要性が確認されてから実装、**リアル移行時** = リアルマネー移行の前提条件。

| # | タスク | 優先度 | 備考 |
|---|--------|--------|------|
| 1 | LLMセンチメント精度ベースラインテスト（200件） | 必須(MVP) | v3: 100件->200件、時間バイアス検定含む |
| 2 | FinBERT/VADERとのベンチマーク比較 | 必須(MVP) | v3: McNemar検定、3プロンプトバリエーション |
| 3 | 決算オーバーリアクション仮説のバックテスト | 必須(MVP) | 4,000件、ステージゲート付き |
| 4 | Phase 0検証ツールキット構築 | 必須(MVP) | v3新規: ARCHのバッチパイプライン |
| 5 | 開発環境構築 | 必須(MVP) | Python仮想環境、alpaca-py SDK、SQLite |
| 6 | Alpaca API接続確認 | 必須(MVP) | ペーパートレーディングアカウントでの疎通 |
| 7 | config.toml設計・実装 | 必須(MVP) | v3: pydantic-settingsによるスキーマバリデーション付き |
| 8 | .env + .gitignore設定 | 必須(MVP) | APIキーの安全な管理 |
| 9 | SQLiteデータベース初期化スクリプト | 必須(MVP) | インデックス、マイグレーション管理含む |
| 10 | 型安全インターフェース定義 | 必須(MVP) | v3新規: modules/types.py（dataclasses+Protocol） |
| 11 | テスト基盤構築 | 必須(MVP) | pytest + conftest.py + カバレッジ設定 |
| 12 | データ収集スクリプト | 必須(MVP) | Alpaca Market Data + News API |
| 13 | LLMセンチメント分析プロンプト設計 | 必須(MVP) | Claude CLIによる売買判断の核 |
| 14 | Claude CLI出力のJSON Schema Validation | 必須(MVP) | v3新規: バリデーション+フォールバック戦略 |
| 15 | テクニカルフィルター実装 | 必須(MVP) | 50日MA, RSI(14), 出来高 |
| 16 | リスク管理モジュール | 必須(MVP) | ポジションサイズ、ストップロス、回路ブレーカー |
| 17 | ブラケット注文実装 | 必須(MVP) | Alpaca OTO注文、limit付きstop order |
| 18 | 注文実行スクリプト | 必須(MVP) | Alpaca APIを通じた売買執行 |
| 19 | Reconciliation実装 | 必須(MVP) | Alpaca APIとローカルDBの照合 |
| 20 | 冪等性メカニズム実装 | 必須(MVP) | ファイルロック + 実行ID + client_order_id |
| 21 | メインオーケストラスクリプト（Python化） | 必須(MVP) | trading_agent.py |
| 22 | launchd設定 | 必須(MVP) | macOS cronからlaunchdへ移行 |
| 23 | バックテスト（ウォークフォワード版） | 必須(MVP) | v3: PurgedTimeSeriesSplit適用 |
| 24 | ストレステスト（5シナリオ） | 必須(MVP) | v3新規: RISKの実データ再現テスト |
| 25 | ペーパートレーディング開始 | 必須(MVP) | 実環境での運用開始 |
| 26 | 撤退自動化メカニズム | 必須(MVP) | v3新規: 撤退基準抵触時の自動停止 |
| 27 | マクロレジーム判定（2変数MVP版） | 必須(MVP) | v3: 4変数->2変数（200日MA+VIX）でMVP開始 |
| 28 | LLMキャリブレーションプロット | 追加 | 確信度と実際の的中率の対応検証 |
| 29 | 相関リスク管理 | 追加 | v3: MVPでは「同一セクター2銘柄制限」で代替 |
| 30 | Slack Webhookアラート | 追加 | 4段階のアラートレベル |
| 31 | CI/CD設定 | 追加 | GitHub Actions（pytest + ruff + mypy） |
| 32 | マクロレジーム4変数モデル拡張 | 追加 | v3: 6ヶ月運用後にデータに基づき判断 |
| 33 | ベイズ事後分布更新 | 追加 | v3: MVPではブートストラップ法のみ |
| 34 | Plattキャリブレーション | 追加 | v3: 100件以上蓄積後に導入判断 |
| 35 | Alpha Decayモニタリング | 追加 | v3新規: STRATのエッジ半減期推定 |
| 36 | 動的相関管理（EWMA） | リアル移行時 | v3新規: RISKのEWMA相関+相関レジーム分類 |
| 37 | 回路ブレーカー段階的厳格化シミュレーション | リアル移行時 | v3新規: RISKの事前シミュレーション |
| 38 | VPS移行（systemd） | リアル移行時 | ARCHのマイグレーションスクリプト |
| 39 | Observability（メトリクス収集） | リアル移行時 | v3新規: ARCHの構造化ログ+異常検知 |
| 40 | テールリスクヘッジ分析 | リアル移行時 | v3新規: RISKのプロテクティブプットコスト分析 |

---

## 2. ペーパートレーディング開始までのタスクリスト

### Phase 0: 仮説検証（Week 1-3）

**目的**: コードを書く前にLLMセンチメントの予測力と決算オーバーリアクション仮説を定量的に検証する。Phase 0の結果でプロジェクトのGo/No-Goを判断する。

**v3変更**: Go/No-Go閾値を65%に引き上げ、サンプル数を200件に拡大、時間バイアス検定を追加、実行プロトコルの精緻化。Phase 0検証ツールキット構築を最初のタスクに追加。

#### Step 0: Phase 0検証ツールキット構築（Day 1-2）【必須(MVP)】

v3新規。ARCHの提案に基づき、4,000件のバッチLLM実行を管理する専用パイプラインを最初に構築する。

- [ ] `tools/phase0_runner.py` -- バッチ実行パイプライン（リジューム対応、中間保存）
- [ ] `tools/phase0_data_collector.py` -- 決算データ収集（yfinance + Alpaca News API）
- [ ] `tools/phase0_report.py` -- Go/No-Goレポート自動生成
- [ ] `data/phase0/results.db` -- Phase 0専用結果DB
- [ ] FinBERT/VADER実行環境構築（ローカル、`transformers` + `vaderSentiment`）

#### Step 1: プロンプト設計と標準化（Day 3-4）【必須(MVP)】

STRATの提案に基づき、本番用プロンプトのv1.0をフリーズし、Phase 0でそのまま使用する。

- [ ] 本番用プロンプト（`prompts/trading_decision.md`）のv1.0をフリーズ
- [ ] Phase 0専用のラッパープロンプトを作成（時間バイアス抑制用）:
  - 「以下の決算情報のみに基づいて判断せよ。株価の事後的な動きに関する知識は使うな。判定日は {earnings_date} として扱え。」
- [ ] LLMプロンプトを3種類用意（簡潔版、詳細版、Chain-of-Thought版）-- QUANTの公正性担保要件

#### Step 2: データ収集（Day 5-8）【必須(MVP)】

- [ ] ソース: yfinance（決算日・EPS・売上）+ Alpaca News API（決算プレスリリース）
- [ ] 対象: S&P500構成銘柄のうちユニバース条件を満たす銘柄
- [ ] サンプリング: 層化抽出法（STRATの提案）
  - 11セクター x 各18件 = 198件（端数調整で200件）
  - 各セクター内ではランダム選定
  - 期間: 直近6ヶ月（2四半期分をカバー）
- [ ] 除外条件: M&A発表と決算が同日の銘柄
- [ ] ゴールドスタンダードラベル付与（5営業日後リターン）
  - 閾値の感度分析: threshold = [0.005, 0.01, 0.015, 0.02] で全て実行（QUANT）
- [ ] 過去2年分の決算データ約4,000件を収集（ステージゲート通過後にフル実行）

**ギャップリスク分布の推定**（RISKの提案、Phase 0と並行）:
- [ ] 4,000件の決算発表後ギャップ幅（翌営業日始値 vs 前日終値）を算出
- [ ] ギャップ幅の分布推定（中央値、90/95/99パーセンタイル、ATR対比倍率）
- [ ] イベント種別ごとのスリッページ係数テーブルを作成

#### Step 3: LLMセンチメント分析パイロット（Day 9-11）【必須(MVP)】

- [ ] 200件に対してClaude CLIでセンチメント分析を実行（3プロンプト x 200件）
- [ ] 出力: `{sentiment, confidence, key_drivers, risk_factors}`
- [ ] コスト: 600回 x ~$0.03 = ~$18
- [ ] 全入力・全出力をJSON保存（再現性確保）

#### Step 4: 時間バイアス検定（Day 12）【必須(MVP)】

v3新規。STRATの提案。LLMの事前知識汚染を検出する。

- [ ] 直近1週間に発表された決算20件で精度を測定
- [ ] 過去6ヶ月200件の精度と比較
- [ ] 有意な差（>10pp）があれば時間バイアスの存在を示唆
- [ ] 差がある場合: 補正精度 = 過去精度 - (過去精度 - 直近精度) * 0.5

#### Step 5: ベースライン比較（Day 13-15）【必須(MVP)】

- [ ] FinBERT: 同一200件で実行（ローカル、コスト$0）
- [ ] VADER: 同一200件で実行（ローカル、コスト$0）
- [ ] ナイーブモデル: 「常にポジティブ」「EPS beatなら常にポジティブ」
- [ ] 統計検定:
  - McNemar検定（QUANTの提案: カイ二乗検定より適切）
  - Brier Score（キャリブレーション品質）
  - 「最低1つのプロンプトバリエーションでFinBERT/VADERとの有意差が出なければ、LLMのエッジはプロンプトに過剰適合」と判断（QUANT）

#### Step 6: ステージゲート判断（Day 16）【必須(MVP)】

パイロット200件の結果で、フル4,000件に進むかを判断する。

| パイロット精度 | 判断 |
|--------------|------|
| >= 65% | フル4,000件に進む |
| 60-64% | 追加200件で再検証（1回のみ） |
| < 60% | No-Go。Phase 0終了 |

#### Step 7: フル実行（パイロットGo判定の場合）（Day 17-19）【必須(MVP)】

- [ ] 4,000件に対してClaude CLIでバッチ実行（推定コスト: $130-150、リトライ込み）
- [ ] 中間保存: 50件ごとにJSONファイルに保存（途中再開可能）
- [ ] FinBERT/VADER同時実行

#### Step 8: シグナル間情報量分析（Day 19）【追加】

v3新規。QUANTの提案。Phase 0データで実行可能、追加コスト$0。

- [ ] Mutual Information分析: LLMセンチメント、MA距離、RSI、出来高比率 vs 5日後リターン
- [ ] Conditional MI: テクニカル指標がLLM以上の追加情報を持つか検証
- [ ] CMI ≈ 0のテクニカル指標はフィルターから除外候補

#### Step 9: Go/No-Go判断（Day 20-21）【必須(MVP)】

**Go/No-Go判断基準（v3改訂）**:

| 条件 | 判断 |
|------|------|
| LLM方向予測精度 >= 65% かつ FinBERT/VADERを有意に上回る かつ **取引コスト控除後ネットリターン > 0%** | **Go**: Phase 1に進む |
| LLM方向予測精度 >= 65% かつ FinBERT/VADERとの差 < 5pp | **条件付Go**: 追加200件で再検証（1回のみ） |
| LLM方向予測精度 < 65% | **No-Go**: 戦略再設計（プランBへ移行） |
| 時間バイアス補正後の精度 < 60% | **No-Go**: LLMの事前知識汚染が深刻 |
| 決算オーバーリアクション仮説のリバウンド率がベースレートと有意差なし | **戦略の重心を再検討** |

**取引コスト控除後ネットリターン計算（v3新規、DEVILの指摘）**:

```
期待リターン/トレード = 精度 x 平均利益 - (1-精度) x 平均損失
年間グロスリターン = 期待リターン/トレード x ポジションサイズ比 x 年間取引数
年間コスト = 取引コスト(スプレッド+スリッページ) + APIコスト
ネットリターン = グロスリターン - 年間コスト

ネットリターン > 0% を確認すること。
```

- [ ] 検証結果レポート作成（Go/No-Go判断基準付き）
- [ ] Phase 0の結果に基づいて**目標リターンを事後的に校正**（STRATの提案）

**予算**: $170（パイロット$18 + フル$150 + リトライバッファ$2）

**Phase 0独立撤退基準（v3新規）**:
- パイロット200件で精度55%未満 -> 即No-Go（フル実行に進まない）
- フル4,000件でNo-Go -> プランBのバックテストを実施し、テクニカルのみ戦略のSRが0.3以上なら戦略切替、そうでなければプロジェクト終了

---

### Phase 1: 環境構築・基盤整備（Week 4-5）

- [ ] Python 3.x仮想環境のセットアップ 【必須(MVP)】
- [ ] 依存パッケージインストール 【必須(MVP)】
  - requirements.txt + requirements-dev.txt（pytest, ruff, mypy等）
  - pyproject.toml作成
- [ ] .envファイル作成 【必須(MVP)】
  - ALPACA_API_KEY, ALPACA_SECRET_KEY, ALPACA_PAPER=true, ANTHROPIC_API_KEY, SLACK_WEBHOOK_URL
- [ ] .gitignore設定（.env, data/, logs/）【必須(MVP)】
- [ ] Alpaca APIペーパートレーディング接続確認 【必須(MVP)】
- [ ] config.toml設計・実装 【必須(MVP)】
  - v3: pydantic-settingsによる型安全バリデーション（ARCHの提案）
  - 型チェック、値域チェック、必須キー検出、デフォルト値管理を組み込み
- [ ] **型安全インターフェース定義（v3新規）**【必須(MVP)】
  - `modules/types.py`: dataclasses + typing.Protocol で全モジュールの入出力型を定義
  - BarData, PortfolioState, TradingDecision, OrderResult 等の共通型
  - DataCollector, StateManager, RiskChecker, LLMAnalyzer, OrderExecutor のProtocol
  - CI追加: `mypy --strict modules/`
- [ ] SQLiteデータベース初期化スクリプト 【必須(MVP)】
  - インデックス追加（positions.symbol, positions.status, trades.symbol等）
  - ISO 8601日付フォーマットのCHECK制約
  - schema_versionテーブルによるマイグレーション管理
  - v3: WAL設定最適化（`wal_autocheckpoint=500`, `busy_timeout=5000`）
  - v3: メトリクステーブルのDDL準備（Phase 2で記録開始）
- [ ] ディレクトリ構成の作成（modules/ Pythonパッケージ化）【必須(MVP)】
- [ ] 基本的なロギング設定 【必須(MVP)】
  - v3: RotatingFileHandler（10MB x 5世代）、構造化ログフォーマット（ARCHの提案）
- [ ] テスト基盤構築（pytest + conftest.py + 共通フィクスチャ）【必須(MVP)】
- [ ] GitHub Actions CI設定 【追加】
  - v3: pytest + ruff + mypy
  - v3: config.toml「1変数ずつ」ルールのCI強制（ARCHの提案）
- [ ] Slack Webhook設定・alerter.py実装 【追加】
  - 4段階アラートレベル: INFO/WARN/ERROR/CRITICAL

**Phase 1独立撤退基準（v3新規）**:
- Alpaca API接続が3日以上確立できない -> 代替プラットフォーム検討
- 基盤構築がWeek 5終了時に完了しない -> スコープを再評価

---

### Phase 2: データ収集・シグナル実装（Week 6-7）

- [ ] Alpaca Market Data API: 株価OHLCV取得 【必須(MVP)】
  - バッチリクエストで複数銘柄を1 APIコールで取得
- [ ] Alpaca News API: ニュース取得 【必須(MVP)】
- [ ] FRED API: マクロ指標取得 【必須(MVP)】
  - MVP: VIX、FF金利（2変数モデル）
  - 追加: T10Y2Y、BAMLH0A0HYM2（4変数モデル拡張時）
- [ ] 銘柄ユニバース構築 【必須(MVP)】
  - S&P500大型株: 出来高100万株以上、スプレッド0.05%以内、時価総額$10B以上
  - 初期30銘柄でスタート
- [ ] Claude CLI売買判断プロンプト設計 【必須(MVP)】
  - 構造化されたreasoning（bull_case/bear_case/catalyst）を強制
  - 確信度の定義を明示し、オーバーコンフィデンス抑制
- [ ] **Claude CLI出力のJSON Schema Validation（v3新規）**【必須(MVP)】
  - ARCHの提案: JSON Schemaによるバリデーション
  - 段階的フォールバック: タイムアウト->リトライ、JSON不正->部分抽出、スキーマ違反(軽微)->サニタイズ
  - jsonschemaパッケージ使用
- [ ] LLMセンチメント分析の出力JSONスキーマ改善 【必須(MVP)】
  - sentiment_analysisの構造化（key_drivers + risk_factors分離）
  - metadataにmodel_version + prompt_version
- [ ] テクニカルフィルター実装 【必須(MVP)】
  - 50日MA、RSI(14)、出来高比較
  - v3: パーセンタイルランク正規化を基本とする（QUANTの提案）
  - v3: 等重みでスタートし、6ヶ月運用後にデータに基づいて重みを1回調整
  - パラメータ感度分析の実施（MA: [10,20,50,100,200]、RSI: [7,14,21]）
- [ ] マクロレジーム判定ロジック 【必須(MVP)】
  - **v3 MVP: 2変数モデル（S&P500 vs 200日MA、VIX）** -- DEVILの複雑性削減提案を採用
  - 判定: 2変数が同一方向ならその判定、不一致なら「レンジ」
  - v3: レジーム遷移のヒステリシス -- 確定には3営業日連続で同一判定を要求（STRATの提案）
- [ ] LLMキャリブレーションプロット 【追加】
  - 確信度10%刻みビン化 -> 実際の的中率プロット
  - ECE（Expected Calibration Error）算出

**Phase 2独立撤退基準（v3新規）**:
- LLMプロンプトがJSON出力を安定的に返せない（エラー率>20%）-> プロンプト根本再設計 or Claude API直接呼び出しに切替

---

### Phase 3: リスク管理・注文実行（Week 8-9）

- [ ] ポジションサイズ計算 【必須(MVP)】
  - ATRベース、最大リスク1.5%
  - v3: イベント種別ごとのスリッページ係数を適用（RISKの提案）
  - 1ポジション上限: 総資金の20%
- [ ] ストップロス・テイクプロフィット自動設定 【必須(MVP)】
  - 多層ストップロス: 第1層ATR x 2.0 + 第2層エントリー-5%絶対値 + 第3層ポートフォリオレベル
  - テイクプロフィット: ATR x 3.0-4.0（リスクリワード比1:1.5-2.0）
  - v3: limit付きstop orderの乖離幅 = ATR x 1.0（RISKの提案）
  - v3: 安全弁 -- リミット価格がエントリー価格の-8%を下回らない
  - v3: 未約定時のフォールバック（midday/eod実行時に再判定）
- [ ] 回路ブレーカー4段階実装 【必須(MVP)】
  - Level 1: 4%, Level 2: 7%, Level 3: 10%, Level 4: 15%
  - Level 1発動後48時間のクーリングオフ期間
  - Level 2: 3営業日50%縮小
  - ドローダウンはHigh Water Mark基準
- [ ] セクター分散チェック 【必須(MVP)】
  - **v3 MVP: 同一セクター最大2ポジション**（静的ルール）
  - VIX > 30でポジション数を3以下に制限
- [ ] **段階的撤退の自動実行（v3新規）**【必須(MVP)】
  - RISKの提案: 機械的なポジション縮小アルゴリズム
  - 10%DD: 3ポジション制限+50%縮小+config.toml自動更新+Slackアラート
  - 12%DD: 1ポジション制限+新規停止+1週間冷却+Slackアラート
  - 15%DD: 全ポジションクローズ+無期限停止フラグ+Slackアラート
  - DEVILの提案: 撤退基準抵触時にtrading_agent.pyが自動停止、再開には手動で`force_resume=true`が必要
- [ ] **保有中銘柄の決算日チェック自動化（v3新規）**【必須(MVP)】
  - RISKの提案: 決算2営業日前にポジション50%縮小
- [ ] 注文実行スクリプト 【必須(MVP)】
  - ブラケット注文（OTO）でストップロス/テイクプロフィットを一体管理
  - limit付きstop orderでフラッシュクラッシュ時の異常安値約定防止
- [ ] Alpacaとの状態同期ロジック 【必須(MVP)】
  - Reconciliationを毎回実行時の最初のステップに配置
  - v3: Alpacaの`get_all_positions()`を2回連続呼び出し、一致確認後にReconciliation実行（DEVILの提案）
  - v3: 差異が3以上の場合は自動修正を停止しアラートのみ送信（DEVILの提案）
- [ ] 二重注文防止メカニズム 【必須(MVP)】
  - 3重防御: ファイルロック + 実行ID + client_order_id
- [ ] エラーハンドリング 【必須(MVP)】
  - Partial Fill対応、Claude CLIタイムアウト（120秒）
  - 市場休場日判定（exchange_calendarsパッケージ）
  - Alpaca APIレートリミット対応デコレータ
- [ ] 相関リスク管理 【追加】
  - セクター間相関マトリクスの月次更新、実効分散度>=2.0
- [ ] 動的相関管理（EWMA）【リアル移行時】
  - v3新規: EWMA相関（日次更新、lambda=0.94）
  - 相関ブレイクアウト警告（20日ローリング相関+2σ超過でアラート）
  - 相関レジーム分類（低/高/超高相関）でポジション上限を動的切替

**Phase 3独立撤退基準（v3新規）**:
- Alpaca APIでブラケット注文が正常に機能しない -> 通常注文+手動ストップロス監視にフォールバック
- 回路ブレーカーロジックの単体テストカバレッジが95%未満 -> Phase 4に進まない

---

### Phase 4: 統合・テスト（Week 10-12）

- [ ] メインオーケストラスクリプト（trading_agent.py）【必須(MVP)】
  - 全Python化（trading_agent.shを廃止）
  - v3: Lambda互換エントリーポイント（ARCHの提案: `handler(event, context)`）
- [ ] launchd設定 【必須(MVP)】
  - ~/Library/LaunchAgents/com.alpaca-trading.{pre-market,morning,midday,eod}.plist
  - DST対応: Python zoneinfo、launchd側はUTC固定
- [ ] ヘルスチェックスクリプト（Python化）【必須(MVP)】
- [ ] **ストレステスト実施（v3新規）**【必須(MVP)】
  - RISKの5つのヒストリカルシナリオで実データ再現テスト:
    1. **2020年3月 COVID-19**: S&P500 -33.9%、VIX 14->82
    2. **2022年1-6月 インフレショック**: S&P500 -23.6%、「茹でガエル」パターン
    3. **2023年3月 SVB危機**: セクター固有ショックの波及パターン
    4. **2024年8月 円キャリーアンワインド**: VIX 16->65の突発的ショック+V字回復
    5. **2010年5月 フラッシュクラッシュ**: 流動性枯渇、limit付きstop検証
  - 結果に基づき回路ブレーカー閾値をキャリブレーション
  - 成果物: docs/stress-test-results.md
- [ ] テスト実行 【必須(MVP)】
  - Layer 1: 単体テスト（リスク管理95%+、注文実行90%+、全体80%+カバレッジ）
  - Layer 2: 結合テスト（Alpaca APIモック、Claude CLIモック、SQLite in-memory DB）
  - Layer 3: E2Eテスト（1サイクル全通し）
  - v3: リスク管理モジュールにはMutation TestingまたはProperty Based Test（hypothesis）を追加（DEVILの提案）
- [ ] 全体結合テスト（ペーパー環境で1週間の試運転）【必須(MVP)】
  - v3: 最初の2週間は1ポジションのみの「カナリアリリース」（DEVILの提案）
- [ ] エッジケーステスト 【必須(MVP)】
  - 市場休場日、API障害シミュレーション、Partial Fill、DST切替日
- [ ] バックテスト（ウォークフォワード版）【必須(MVP)】
  - 期間: 過去3年分
  - v3: PurgedTimeSeriesSplit適用（QUANTの提案）
    - n_splits=5、学習期間252日、テスト期間63日
    - purge_days=10（最大保有期間分）、embargo_days=5
    - Expanding Window基本
  - v3: レジーム別パフォーマンスを各フォールドで記録（QUANT）
  - コストモデル: スプレッド0.02-0.05% + スリッページモデル
  - 統計検定: ブートストラップ法でSR信頼区間、モンテカルロシミュレーション
  - デフレーション係数0.7を適用して評価
- [ ] ログ出力の確認 【必須(MVP)】
- [ ] macOSスリープ防止（launchdのスリープ復帰後実行保証で対応）【必須(MVP)】
- [ ] DBバックアップ設定 【追加】
  - v3: SQLite Online Backup API使用（ARCHの提案）、日次バックアップ、7世代保持
- [ ] VPSマイグレーション準備 【リアル移行時】
  - v3: deploy/ディレクトリにsystemdテンプレートを配置（ARCHの提案）

**Phase 4独立撤退基準（v3新規）**:
- バックテストでSR < 0.3（デフレーション係数適用後）-> 戦略パラメータ再調整（1回のみ）。再テストでもSR < 0.3 -> プランBに移行
- ストレステストで5シナリオ中2つ以上で20%超のドローダウン -> リスクパラメータの根本見直し

---

### Phase 5: ペーパートレーディング運用（Month 3-15 -- 12ヶ月間）

v3: 検証期間12ヶ月を維持するが、12ヶ月は「必要だが十分ではない」ことを明記（DEVILの指摘）。リアル移行は「確信」ではなく「暫定的判断」。

- [ ] 本格ペーパートレーディング開始 -- 最初の2週間は1ポジション「カナリアリリース」
- [ ] **撤退自動化メカニズム稼働（v3新規）**【必須(MVP)】
  - DEVILの提案: 月次チェックポイントで撤退基準に抵触した場合、trading_agent.pyが自動的に新規エントリーを停止
  - 再開には手動で `config.toml` の `force_resume = true` を設定（撤退のハードルを下げ、継続のハードルを上げる）
- [ ] 月次チェックポイント評価（毎月末に以下を実施）:
  - シャープレシオ、プロフィットファクター、最大DD、SPY比較
  - LLMキャリブレーションプロット更新
  - ブートストラップ法でSR信頼区間
  - 撤退基準チェック（自動停止トリガー）
  - DEVILによる月次反論レビュー
- [ ] **Alpha Decayモニタリング（v3新規）**【追加】
  - STRATの提案: 月次精度トラッキング開始
  - 精度の3ヶ月移動平均を計算
  - 移動平均が2ヶ月連続で低下 -> Alpha Decay Warning
  - 移動平均がPhase 0基準（65%）に到達 -> Alpha Decay Critical
  - 6ヶ月後にエッジ半減期の初回推定
- [ ] 1ヶ月目: LLMセンチメント精度検証（混同行列の月次レポート、最低61件のサンプル確保）
- [ ] 日次レポート自動生成
- [ ] 週次パフォーマンスレビュー
- [ ] 月次KPI評価
  - ベンチマーク: SPY、Equal Weight S&P500 (RSP)、ランダムエントリー+同一リスク管理
- [ ] 段階的目標設定（v3改訂）:

| フェーズ | 期間 | No-Go基準（独立判断） | 目標SR |
|----------|------|--------------------|--------|
| 検証期 | Month 1-3 | SR < 0かつ改善傾向なし -> 即時撤退 | > 0.3 |
| 改善期 | Month 4-6 | 3ヶ月連続SPY劣後 -> 戦略根本見直し | > 0.5 |
| 成熟期 | Month 7-12 | SR < 0.5が3ヶ月連続 -> プロジェクト停止 | > 0.8 |

v3変更: DEVILの指摘を反映し、各フェーズに**独立したNo-Go基準**を設定。「合格」（=撤退しない条件）と「失格」（=強制撤退条件）を明確に区別。段階的目標がサンクコストトラップにならないよう、各段階で独立した判断を行う。

- [ ] 戦略改善サイクル（仮説->検証->測定->学習、1変数ずつ）
  - パラメータ変更のクールダウン: 前回変更から最低20取引完了まで次の変更禁止
  - v3: 多重比較補正をBonferroni -> Benjamini-Hochberg (BH) 法に変更（QUANTの提案）
    - FDR水準: alpha = 0.10
    - 探索的分析と確証的分析を分離
  - 改善が統計的に有意でない場合は元に戻す
- [ ] **銘柄ユニバース段階的拡大（v3精緻化、STRATの提案）**:
  - 「シグナル頻度」= Stage 2通過後の最終エントリーシグナル数/月
  - 月間シグナル数 < 5 -> 即時拡大（30->50銘柄）
  - 拡大後2ヶ月の追加銘柄群の品質が既存を1pp以上下回る -> 元に戻す
  - 評価タイミング: 2ヶ月目終了時（初回）、以後毎月
- [ ] **累積APIコスト中間レビュー（v3新規）**:
  - DEVILの提案: $300到達時に「残り$200で何が検証できるか」を強制レビュー
- [ ] 6ヶ月後追加検討:
  - ベイズ事後分布更新の導入判断 【追加】
  - Plattキャリブレーションの導入判断 【追加】
  - マクロレジーム4変数モデル拡張の判断 【追加】
  - LLMセンチメント精度の再テスト（Phase 0と同一手法）【追加】
  - エッジ半減期の推定（半減期 < 12ヶ月なら戦略根本再設計）【追加】
- [ ] 12ヶ月経過時の総合評価

---

## 3. 各タスクの担当エージェント

| タスク | 担当 | Phase | 優先度 |
|--------|------|-------|--------|
| Phase 0検証ツールキット構築 | ARCH | 0 | 必須(MVP) |
| LLMセンチメント精度テスト（200件+時間バイアス検定） | STRAT + QUANT | 0 | 必須(MVP) |
| FinBERT/VADERベンチマーク比較（McNemar検定） | QUANT | 0 | 必須(MVP) |
| 決算オーバーリアクション仮説バックテスト | STRAT + QUANT | 0 | 必須(MVP) |
| ギャップリスク分布推定 | RISK | 0 | 必須(MVP) |
| シグナル間MI分析 | QUANT | 0 | 追加 |
| Go/No-Go判断レポート | STRAT + QUANT + DEVIL | 0 | 必須(MVP) |
| 型安全インターフェース定義 | ARCH | 1 | 必須(MVP) |
| config.toml（pydantic-settings） | ARCH | 1 | 必須(MVP) |
| SQLite初期化（WAL最適化含む） | ARCH | 1 | 必須(MVP) |
| テスト基盤構築 | ARCH | 1 | 必須(MVP) |
| Claude CLI JSON Schema Validation | ARCH | 2 | 必須(MVP) |
| テクニカルフィルター（パーセンタイルランク正規化） | QUANT | 2 | 必須(MVP) |
| マクロレジーム判定（2変数MVP） | STRAT | 2 | 必須(MVP) |
| ポジションサイズ（イベント別スリッページ係数） | RISK | 3 | 必須(MVP) |
| limit付きstop order設計 | RISK | 3 | 必須(MVP) |
| 段階的撤退自動化 | RISK + ARCH | 3 | 必須(MVP) |
| 保有銘柄決算日チェック自動化 | RISK | 3 | 必須(MVP) |
| Reconciliation（2回呼び出し、閾値付き） | ARCH | 3 | 必須(MVP) |
| ストレステスト5シナリオ | RISK + ARCH | 4 | 必須(MVP) |
| バックテスト（PurgedTimeSeriesSplit） | QUANT | 4 | 必須(MVP) |
| Alpha Decayモニタリング | STRAT | 5 | 追加 |
| BH法による多重比較補正 | QUANT | 5 | 追加 |
| 動的相関管理（EWMA） | RISK | リアル | リアル移行時 |
| 回路ブレーカー厳格化シミュレーション | RISK | リアル | リアル移行時 |
| VPS移行 | ARCH | リアル | リアル移行時 |
| 月次反論レビュー | DEVIL | 全Phase | 必須(MVP) |
| 撤退自動化メカニズム | DEVIL + ARCH | 3, 5 | 必須(MVP) |

### ロール定義

- **STRAT** -- 戦略立案担当。Phase 0の精緻化されたプロトコル設計、銘柄ユニバース、マクロレジーム（2変数MVP）、Alpha Decayモニタリング
- **QUANT** -- クオンツ担当。Phase 0検証ツールの統計部分、テクニカルフィルター（パーセンタイルランク正規化）、PurgedTimeSeriesSplit、BH法、MI分析
- **RISK** -- リスク管理担当。ギャップリスク分布推定、limit付きstop order、段階的撤退の自動化、ストレステスト5シナリオ、動的相関管理
- **ARCH** -- アーキテクト担当。Phase 0検証ツールキット、型安全インターフェース、JSON Schema Validation、config.toml（pydantic-settings）、Reconciliation堅牢化、VPS移行準備
- **DEVIL** -- 批判的分析担当。月次反論レビュー、撤退自動化の設計監督、Go/No-Go閾値の監視、サンクコスト警告

---

## 4. ペーパーからリアルへの移行基準（数値で定義）

### 必須基準（全て満たすこと）

v3変更: SR基準を0.8に統一（DEVILの指摘で1.0を削除）。レジーム条件付きパフォーマンスを追加。ブートストラップ法を必須、ベイズは追加条件。

| 基準 | 条件 | 根拠 |
|------|------|------|
| 最低取引回数 | **300回以上** | 二項検定でp<0.05を達成 |
| 最低運用期間 | **12ヶ月以上** | 複数の市場環境を経験（ただし「十分」ではなく「暫定的」） |
| シャープレシオ | **> 0.8** | v3: SR>1.0の記載を削除（Kelly基準との整合性確保） |
| SR信頼区間 | ブートストラップ法でSR信頼区間の下限 > 0 | 統計的有意性の確保 |
| レジーム条件付きSR（v3新規） | ブル期SR>0.5 かつ レンジ期SR>0.3 かつ ベア期損失<SPY | ロバストネスの確認 |
| レジーム経験 | ブル/ベア/レンジ各1回以上経験。**1つでも未経験なら移行延期** | v3: DEVILの指摘を反映 |
| 最大ドローダウン | < 15% | 破産リスク防止 |
| プロフィットファクター | > 1.5 | 収益性の確認 |
| ベンチマーク超過 | SPYを年率5%以上上回る（v3: **取引コスト込みネットリターン**で計算） | 受動投資に対する優位性 |
| システム安定性 | 計画外停止0回/月 | 運用信頼性 |
| 回路ブレーカー | Level 3以上の発動0回 | リスク管理の有効性 |
| ベイズ事後確率（追加条件） | P(SR > 0.5 \| data) > 90%（事前分布感度分析で全パターン80%以上） | v3: 導入時のみ。MVPではブートストラップのみ |

### 追加移行条件（v3新規）

| 条件 | 内容 |
|------|------|
| ストレステスト合格 | 5シナリオ全てで最大DD < 20% |
| 回路ブレーカーシミュレーション | リアル厳格化閾値でLevel 1が月2回以下 |
| Alpha Decay確認 | LLMセンチメント精度が65%以上を維持（6ヶ月移動平均） |
| VPS移行完了 | macOSからVPSへのインフラ移行（常時稼働環境） |

### リアル移行時の段階的アプローチ

1. **Stage 1**: 資金の10%で**2ヶ月**
2. **Stage 2**: 資金の30%で1ヶ月
3. **Stage 3**: 資金の50%で1ヶ月
4. **Stage 4**: 全額投入

各Stageの移行条件:
- 前Stageでシャープレシオ > 0.8を維持
- 前Stageで最大ドローダウン < 10%
- システム障害なし
- 最低20取引を確保

**逆戻り条件**:
| 条件 | アクション |
|------|-----------|
| 現Stageでドローダウン > 前Stageの閾値 | 前Stageに戻る |
| 現StageでSR < 0.5 | 前Stageに戻り、2ヶ月再検証 |
| Level 2以上の回路ブレーカー発動 | Stage 1に戻る |
| Level 3以上の回路ブレーカー発動 | ペーパーに戻る |

**リアル移行時の回路ブレーカー段階的厳格化（v3改訂、RISKの提案）**:

一気に50%引き下げではなく、Stageに応じた段階的厳格化を適用する。

| Stage | Level 1 | Level 2 | Level 3 | Level 4 |
|-------|---------|---------|---------|---------|
| ペーパー | 4% | 7% | 10% | 15% |
| Stage 1 | 3% | 5% | 7.5% | 12% |
| Stage 2 | 2.5% | 4.5% | 6% | 10% |
| Stage 3-4 | 2% | 3.5% | 5% | 10% |

v3: Stage 1の最初の2週間は「観察モード」（発動条件に達してもログとアラートのみ、実クローズなし）で運用し、発動頻度の実データを収集してから閾値を調整（RISKの提案）。

---

### 撤退基準

#### 月次チェックポイント（自動停止トリガー付き）

v3変更: DEVILの提案を反映し、撤退基準に抵触した場合のシステム自動停止を組み込む。

| 月 | チェック内容 | No-Go条件（自動停止） | 要注意ゾーン |
|----|-------------|---------------------|------------|
| 1ヶ月目 | LLMセンチメント精度 | 55%未満 -> 自動停止 | 55-65% -> 精密分析 |
| 2ヶ月目 | SPY対比リターン | SPYに-15%以上劣後 -> 自動停止 | -10%以上劣後 -> 要注意 |
| 3ヶ月目 | 総合KPI | SR < 0かつ改善傾向なし -> 自動停止 | SR 0-0.3 -> 要注意 |
| 4-6ヶ月目 | トレンド確認 | 3ヶ月連続SPY劣後 -> 自動停止 | 2ヶ月連続劣後 -> 警告 |
| 7-12ヶ月目 | 成熟度評価 | SR < 0.5が3ヶ月連続 -> 自動停止 | SR 0.5-0.8 -> 改善継続 |

自動停止時の動作:
1. trading_agent.pyが新規エントリーを停止
2. Slackに「撤退基準に抵触」アラート送信
3. 再開には手動で `config.toml` の `force_resume = true` を設定（意図的に継続のハードルを上げる）

#### 段階的撤退（ドローダウンベース）

| ドローダウン | アクション |
|-------------|-----------|
| 10% | ポジション数を3に制限 + ポジションサイズ50%縮小（自動実行） |
| 12% | ポジション数を1に制限 + 1週間の冷却期間（自動実行） |
| 15% | 無期限停止（自動実行） |

v3新規: 冷却期間後の復帰条件（RISKの提案）:
- 冷却期間（7営業日）が経過
- VIX < 25
- 直近5営業日のSPYリターンが > 0%
- 復帰後のポジション上限は1（段階的に2->3->5と緩和、各2週間）

#### 確定的撤退基準

| 条件 | アクション |
|------|-----------|
| 6ヶ月連続でSPYに劣後 | プロジェクト停止 |
| LLMセンチメント精度55%未満（1ヶ月目） | プランBに移行 |
| 累計ドローダウン15%超 | 無期限停止 |
| 累計APIコスト$500超 | プロジェクト停止 |
| 累計APIコスト$300到達（v3新規） | 中間レビュー強制（残り$200の使途を計画） |
| Alpha Decay: 3ヶ月移動平均が65%以下（v3新規） | プランCに移行（LLMをリスクフィルターに転換） |

#### プランB/C（失敗時のフォールバック）

| シナリオ | フォールバック |
|----------|-------------|
| LLM精度不足（65%未満） | **プランB**: テクニカルフィルターのみの戦略に簡素化。LLMはレポート生成にのみ使用 |
| 取引頻度不足（月5取引未満） | ユニバースを50-80銘柄に拡大。マクロイベントシグナルを追加 |
| SR < 0.3（3ヶ月後） | 戦略の根本見直し。決算ドリブンからセクターモメンタム戦略に転換 |
| 15%ドローダウン到達 | 完全撤退。SPYのバイ&ホールドに切替 |
| APIコスト超過 | モデルをHaiku等の低コストモデルに切替 |
| Alpha Decay（v3新規） | **プランC**: LLMの役割をシグナル生成->リスクフィルターに転換。テクニカル/モメンタムでエントリー、LLMはネガティブリスクスクリーニングに使用 |
| Alpha Decay + プランC不奏功 | マルチモデルアンサンブル（Claude + GPT-4 + Gemini）を検討。3モデル一致=高確信 |

v3新規: プランBのプロトタイプをPhase 0と同時に構築（DEVILの提案）。テクニカルのみ戦略のバックテストを実施し、プランBの実行可能性を事前確認。

---

## 5. パラメータ管理

### 明示的パラメータ（5個）

| パラメータ | 初期値 | 管理場所 |
|-----------|--------|---------|
| LLM確信度閾値 | 70% | config.toml |
| MA期間 | 50日 | config.toml |
| ストップロス | ATR x 2.0 | config.toml |
| テイクプロフィット | ATR x 3.0 | config.toml |
| タイムストップ | 10営業日 | config.toml |

### 暗黙的パラメータ（7個）

| パラメータ | 初期値 | 管理場所 |
|-----------|--------|---------|
| RSI期間 | 14 | config.toml |
| RSI上限/下限 | 70/30 | config.toml |
| 出来高比較期間 | 20日 | config.toml |
| マクロレジームVIX閾値 | 20/30 | config.toml |
| マクロレジームMA期間 | 200日 | config.toml |
| ATR期間 | 14 | config.toml |
| 最小保有期間 | 2日 | config.toml |

合計12個。全てconfig.tomlでgit管理し、変更時はPRを通す。strategy_paramsテーブルに変更履歴を自動記録する。

v3追加: config.tomlの型・値域バリデーションをpydantic-settingsで実装。CIで「1変数ずつ」ルールを自動強制。

---

## 6. 工数見積もり（v3改訂）

DEVILの指摘（v2全実装: 178h開発+39h/月メンテ）を受け、MVP構成での現実的な工数を再計算。

### MVP構成（ペーパートレーディング開始に必要な最小限）

| Phase | 期間 | 開発工数 | 内容 |
|-------|------|---------|------|
| 0 | Week 1-3 | 30h | 検証ツールキット構築、200件パイロット、4,000件フル検証、Go/No-Goレポート |
| 1 | Week 4-5 | 20h | 環境構築、config.toml(pydantic)、型定義、DB、テスト基盤 |
| 2 | Week 6-7 | 25h | データ収集、LLMプロンプト+JSON Validation、テクニカルフィルター、2変数マクロ |
| 3 | Week 8-9 | 25h | リスク管理、limit付きstop、撤退自動化、注文実行、Reconciliation |
| 4 | Week 10-12 | 20h | trading_agent.py、launchd、ストレステスト5シナリオ、バックテスト、テスト |
| **合計** | **12週間** | **120h** | |

### 月次メンテナンス（MVP構成）

| 項目 | 工数/月 |
|------|---------|
| 月次チェックポイント評価 | 3h |
| キャリブレーションプロット更新 | 1h |
| 戦略改善サイクル | 6h |
| DEVILレビュー対応 | 2h |
| バグ修正・API変更対応 | 3h |
| **合計** | **15h/月** |

### 追加機能（運用データで必要性が確認されてから実装）

| 機能 | 推定工数 | 導入時期 |
|------|---------|---------|
| マクロ4変数モデル拡張 | 8h | 6ヶ月後 |
| 相関マトリクス月次更新 | 12h | 6ヶ月後 |
| ベイズ事後分布更新 | 16h | 6ヶ月後 |
| Plattキャリブレーション | 8h | 100件蓄積後 |
| Alpha Decayモニタリング | 4h | 3ヶ月後 |
| Slack Webhook | 8h | Phase 2以降 |
| CI/CD | 4h | Phase 2以降 |
| Observability | 8h | リアル移行前 |

v3の方針: **「やるべきことの半分を捨てる勇気を持て」（DEVIL）**。追加機能は「運用データが必要性を証明した場合にのみ」実装する。

---

## 7. スケジュールサマリー

| Phase | 期間 | 内容 | 主な成果物 | MVP工数 |
|-------|------|------|-----------|---------|
| 0 | Week 1-3 | 仮説検証 | Go/No-Goレポート、ギャップリスク分布 | 30h |
| 1 | Week 4-5 | 環境構築・基盤整備 | 開発環境、DB、型定義、テスト基盤 | 20h |
| 2 | Week 6-7 | データ収集・シグナル実装 | データパイプライン、LLM+JSONバリデーション、テクニカル | 25h |
| 3 | Week 8-9 | リスク管理・注文実行 | リスク管理、撤退自動化、注文実行、Reconciliation | 25h |
| 4 | Week 10-12 | 統合・テスト | trading_agent.py、ストレステスト、バックテスト | 20h |
| 5 | Month 3-15 | ペーパートレーディング | 12ヶ月の運用実績、月次レポート | 15h/月 |

**総プロジェクト期間**: 約15ヶ月（開発3ヶ月 + ペーパートレーディング12ヶ月）
**MVP開発工数**: 120h（3ヶ月 x 40h/月 = 週10時間ペース）
**年間メンテ工数**: 180h（15h/月 x 12ヶ月）
**総工数**: 300h（MVP開発120h + 年間メンテ180h）

---

## 8. リスクレジスター（v3改訂）

| # | リスク | 影響度 | 発生確率 | 対策 | 指摘元 |
|---|--------|--------|---------|------|--------|
| 1 | LLMにalphaが存在しない | 致命的 | 中 | Phase 0で事前検証、**65%**未満でNo-Go（v3引上げ）| STRAT, DEVIL |
| 2 | 12ヶ月300取引でも統計的に不十分 | 高 | 高 | 12ヶ月は「暫定的判断」と明記、レジーム条件付きSRで評価 | QUANT, DEVIL |
| 3 | Alpha Decay（LLMエッジの消失） | 致命的 | 高 | 月次精度トラッキング、エッジ半減期推定、プランC準備 | STRAT, DEVIL |
| 4 | ギャップダウンでストップロスが機能しない | 高 | 中 | limit付きstop、イベント別スリッページ係数、ギャップ分布推定 | RISK |
| 5 | 相関ショックで全ポジション同時被弾 | 高 | 低 | MVP: 同一セクター2銘柄制限。追加: EWMA相関、相関レジーム | RISK |
| 6 | Claude APIモデル変更でパフォーマンス急変 | 高 | 中 | metadataにmodel_version記録、精度の月次モニタリング | DEVIL |
| 7 | macOS cron/スリープの信頼性不足 | 中 | 高 | launchd移行、VPS移行パスの準備 | ARCH, DEVIL |
| 8 | 二重注文 | 高 | 中 | 3重防御（ファイルロック+実行ID+client_order_id）| ARCH |
| 9 | AlpacaとローカルDBの状態不整合 | 中 | 高 | 2回呼び出し確認付きReconciliation、閾値付き自動修正 | ARCH, DEVIL |
| 10 | サンクコスト効果でやめられない | 高 | 高 | **撤退自動化**、累積APIコスト$300中間レビュー、DEVIL月次レビュー | DEVIL |
| 11 | v2の複雑性爆発で実装しきれない | 高 | 高 | **MVP思想**、全タスク3段階優先度、工数120hに抑制 | DEVIL |
| 12 | Claude CLI出力の異常でシグナル欠落 | 中 | 中 | JSON Schema Validation + フォールバック戦略 | ARCH |
| 13 | テストカバレッジの罠（行は通るがバグは残る） | 中 | 中 | Mutation Testing/Property Based Test（リスク管理のみ）| DEVIL |
| 14 | 目標リターンとKelly基準の不整合 | 中 | 高 | Phase 0結果に基づく事後的校正、ネットリターンで目標設定 | STRAT, DEVIL |
